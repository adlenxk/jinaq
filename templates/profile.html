{% extends "base.html" %}
{% block content %}
<div class="container mx-auto px-4 py-12">
    <div class="max-w-5xl mx-auto">
        <div class="grid grid-cols-1 md:grid-cols-3 gap-8">
            <div class="md:col-span-1">
                <div class="bg-white rounded-2xl shadow-sm p-6 mb-6">
                    <div class="relative group w-32 h-32 mx-auto mb-4">
                        <img id="avatarPreview" src="{{ avatar_url }}" class="w-full h-full object-cover rounded-2xl"
                            alt="Profile picture">
                        <label
                            class="absolute inset-0 rounded-2xl bg-black bg-opacity-50 opacity-0 group-hover:opacity-100 flex items-center justify-center cursor-pointer transition-opacity">
                            <span class="text-white text-sm">Change Photo</span>
                            <input type="file" name="avatar" accept="image/*" class="hidden"
                                onchange="previewImage(this)">
                        </label>
                    </div>

                    <div class="flex items-center justify-center md:justify-start gap-4">
                        <h1 class="text-3xl font-bold gradient-text">
                            {{ user_data.full_name if user_data and user_data.full_name else 'Your Name' }}
                        </h1>

                        {% if user_data.verified %}
                        <div class="tooltip"
                            data-tip="{{ 'Официально подтвержденный аккаунт' if user_data.verification_type == 'official' else 'Верифицированный аккаунт' }}">
                            <svg xmlns="http://www.w3.org/2000/svg"
                                class="h-6 w-6 text-blue-500 transition-all duration-300 transform hover:scale-110 hover:rotate-6"
                                viewBox="0 0 20 20" fill="currentColor">
                                <path fill-rule="evenodd"
                                    d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z"
                                    clip-rule="evenodd" />
                            </svg>
                        </div>
                        {% endif %}

                        <button onclick="copyProfileLink()" class="btn btn-ghost btn-sm" title="Copy Profile Link">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-gray-500 hover:text-black"
                                fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z" />
                            </svg>
                        </button>
                    </div>

                    <p class="text-gray-600 mt-2 flex items-center justify-center md:justify-start gap-2">
                        @{{ user_data.username if user_data else '' }}

                    </p>

                    <div class="flex justify-center gap-2 mt-4">
                        <span class="px-3 py-1 bg-gray-100 rounded-full text-sm">
                            {{ certificates|length }} Certificates
                        </span>
                        <span class="px-3 py-1 bg-gray-100 rounded-full text-sm">
                            Member since {{ user_data.created_at.strftime('%B %Y') if user_data and user_data.created_at
                            else 'Recently' }}
                        </span>
                    </div>
                </div>

                <div class="bg-white rounded-2xl shadow-sm p-6 mb-6">
                    <h2 class="text-xl font-semibold mb-4">Profile Information</h2>
                    <form method="POST" enctype="multipart/form-data" id="profileForm">
                        <div class="space-y-4">
                            <div class="form-control">
                                <label class="label">Full Name</label>
                                <input type="text" name="full_name" class="input input-bordered bg-gray-50"
                                    value="{{ user_data.full_name if user_data else '' }}">
                            </div>

                            <div class="form-control">
                                <label class="label">Bio</label>
                                <textarea name="bio"
                                    class="textarea textarea-bordered bg-gray-50 min-h-[100px]">{{ user_data.bio if user_data else '' }}</textarea>
                            </div>

                            <div class="form-control">
                                <label class="label">Education</label>
                                <textarea name="education"
                                    class="textarea textarea-bordered bg-gray-50">{{ user_data.education if user_data else '' }}</textarea>
                            </div>

                            <button type="submit" class="btn bg-black hover:bg-gray-800 text-white w-full">
                                Save Changes
                            </button>
                        </div>
                    </form>
                </div>


                <div class="bg-white rounded-2xl shadow-sm p-6">
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-xl font-semibold">Your Links</h2>
                        <button type="button" onclick="addLink()"
                            class="btn btn-ghost text-primary hover:bg-primary/10">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24"
                                stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M12 4v16m8-8H4" />
                            </svg>
                            Add Link
                        </button>
                    </div>

                    <form id="linksForm" class="space-y-4">
                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                        <div id="linksContainer" class="space-y-4">
                            {% if user_data.links %}
                            {% for link in user_data.links %}
                            <div
                                class="link-entry group p-4 bg-gray-50 rounded-xl hover:bg-gray-100 transition-all duration-200">
                                <div class="flex items-start gap-4">
                                    <div class="link-icon flex-shrink-0 mt-2">
                                        {% if 'linkedin.com' in link.url %}
                                        <svg class="h-8 w-8 text-[#0A66C2]" fill="currentColor" viewBox="0 0 24 24">
                                            <path
                                                d="M19 0h-14c-2.761 0-5 2.239-5 5v14c0 2.761 2.239 5 5 5h14c2.762 0 5-2.239 5-5v-14c0-2.761-2.238-5-5-5zm-11 19h-3v-11h3v11zm-1.5-12.268c-.966 0-1.75-.79-1.75-1.764s.784-1.764 1.75-1.764 1.75.79 1.75 1.764-.783 1.764-1.75 1.764zm13.5 12.268h-3v-5.604c0-3.368-4-3.113-4 0v5.604h-3v-11h3v1.765c1.396-2.586 7-2.777 7 2.476v6.759z" />
                                        </svg>
                                        {% elif 'github.com' in link.url %}
                                        <svg class="h-8 w-8 text-[#181717]" fill="currentColor" viewBox="0 0 24 24">
                                            <path
                                                d="M12 0c-6.626 0-12 5.373-12 12 0 5.302 3.438 9.8 8.207 11.387.599.111.793-.261.793-.577v-2.234c-3.338.726-4.033-1.416-4.033-1.416-.546-1.387-1.333-1.756-1.333-1.756-1.089-.745.083-.729.083-.729 1.205.084 1.839 1.237 1.839 1.237 1.07 1.834 2.807 1.304 3.492.997.107-.775.418-1.305.762-1.604-2.665-.305-5.467-1.334-5.467-5.931 0-1.311.469-2.381 1.236-3.221-.124-.303-.535-1.524.117-3.176 0 0 1.008-.322 3.301 1.23.957-.266 1.983-.399 3.003-.404 1.02.005 2.047.138 3.006.404 2.291-1.552 3.297-1.23 3.297-1.23.653 1.653.242 2.874.118 3.176.77.84 1.235 1.911 1.235 3.221 0 4.609-2.807 5.624-5.479 5.921.43.372.823 1.102.823 2.222v3.293c0 .319.192.694.801.576 4.765-1.589 8.199-6.086 8.199-11.386 0-6.627-5.373-12-12-12z" />
                                        </svg>
                                        {% else %}
                                        <div class="h-8 w-8 rounded-lg bg-gray-200 flex items-center justify-center">
                                            <svg class="h-5 w-5 text-gray-500" fill="none" viewBox="0 0 24 24"
                                                stroke="currentColor">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                                    d="M13.828 10.172a4 4 0 00-5.656 0l-4 4a4 4 0 105.656 5.656l1.102-1.101m-.758-4.899a4 4 0 005.656 0l4-4a4 4 0 00-5.656-5.656l-1.1 1.1" />
                                            </svg>
                                        </div>
                                        {% endif %}
                                    </div>
                                    <div class="flex-grow space-y-3">
                                        <div class="form-control">
                                            <input type="text" name="link_titles[]" placeholder="Link Title"
                                                class="input input-bordered w-full bg-white" value="{{ link.title }}"
                                                required>
                                        </div>
                                        <div class="form-control">
                                            <div class="relative">
                                                <input type="url" name="link_urls[]" placeholder="https://example.com"
                                                    pattern="https?://.*"
                                                    class="input input-bordered w-full pr-10 bg-white"
                                                    value="{{ link.url }}" required>
                                                <button type="button" onclick="validateUrl(this)"
                                                    class="absolute right-2 top-1/2 -translate-y-1/2 text-gray-400 hover:text-gray-600">
                                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none"
                                                        viewBox="0 0 24 24" stroke="currentColor">
                                                        <path stroke-linecap="round" stroke-linejoin="round"
                                                            stroke-width="2" d="M5 13l4 4L19 7" />
                                                    </svg>
                                                </button>
                                            </div>
                                            <span class="text-xs text-gray-500 mt-1">Start with http:// or
                                                https://</span>
                                        </div>
                                    </div>
                                    <div class="flex-shrink-0 space-y-2">
                                        <button type="button"
                                            class="remove-link-btn btn btn-ghost btn-sm text-red-500 hover:bg-red-50">
                                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none"
                                                viewBox="0 0 24 24" stroke="currentColor">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                                    d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                                            </svg>
                                        </button>
                                    </div>
                                </div>
                            </div>
                            {% endfor %}
                            {% endif %}
                        </div>

                        <div class="flex justify-end mt-6">
                            <button type="submit" class="btn bg-black hover:bg-gray-800 text-white min-w-[120px]">
                                Save Changes
                            </button>
                        </div>
                    </form>
                </div>
            </div>

            <div class="md:col-span-2 space-y-6">
                <div class="bg-white rounded-2xl shadow-sm p-6">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-xl font-semibold">Certificates</h2>
                        <button onclick="showUploadModal()" class="btn bg-black hover:bg-gray-800 text-white">
                            Add Certificate
                        </button>
                    </div>
                    {% if certificates %}
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                        {% for cert_doc in certificates %}
                        {% set cert = cert_doc.to_dict() %}
                        <div class="card bg-gray-50 hover:bg-gray-100 transition-colors">
                            {% if cert.file_url and (cert.file_url.endswith('.jpg') or
                            cert.file_url.endswith('.jpeg')
                            or cert.file_url.endswith('.png')) %}
                            <figure class="relative h-48">
                                <img src="{{ cert.file_url }}" alt="{{ cert.title }}"
                                    class="w-full h-full object-cover">
                            </figure>
                            {% else %}
                            <div class="h-48 flex items-center justify-center bg-gray-100">
                                <svg class="h-16 w-16 text-gray-400" fill="none" viewBox="0 0 24 24"
                                    stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                                </svg>
                            </div>
                            {% endif %}
                            <div class="card-body">
                                <h3 class="card-title">{{ cert.title }}</h3>
                                {% if cert.uploaded_at %}
                                <p class="text-sm text-gray-500">
                                    {{ cert.uploaded_at.strftime('%B %d, %Y') }}
                                </p>
                                {% endif %}
                                <div class="card-actions justify-between mt-4">
                                    <a href="{{ cert.file_url }}" target="_blank"
                                        class="btn btn-sm bg-black hover:bg-gray-800 text-white">
                                        View
                                    </a>
                                    <button onclick="deleteCertificate('{{ cert_doc.id }}')"
                                        class="btn btn-sm btn-ghost text-red-500">
                                        Delete
                                    </button>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                    {% else %}
                    <div class="text-center py-12 bg-gray-50 rounded-xl">
                        <svg class="mx-auto h-12 w-12 text-gray-400" fill="none" viewBox="0 0 24 24"
                            stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M9 13h6m-3-3v6m5 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                        </svg>
                        <h3 class="mt-2 text-sm font-medium text-gray-900">No certificates</h3>
                        <p class="mt-1 text-sm text-gray-500">Get started by adding your first certificate</p>
                        <div class="mt-6">
                            <button onclick="showUploadModal()" class="btn bg-black hover:bg-gray-800 text-white">
                                Add Certificate
                            </button>
                        </div>
                    </div>
                    {% endif %}
                </div>
                <div class="bg-white rounded-2xl shadow-sm p-6">
                    <h2 class="text-2xl font-bold mb-4">Academic Portfolio</h2>
                    <form id="academicPortfolioForm">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div class="form-control">
                                <label class="label">GPA</label>
                                <input type="text" name="gpa" placeholder="Enter your GPA" class="input input-bordered"
                                    value="{{ user_data.academic_info.gpa }}">
                            </div>

                            <div class="form-control">
                                <label class="label">SAT Score</label>
                                <input type="text" name="sat_score" placeholder="Enter SAT Score"
                                    class="input input-bordered" value="{{ user_data.academic_info.sat_score }}">
                            </div>

                            <div class="form-control">
                                <label class="label">TOEFL Score</label>
                                <input type="text" name="toefl_score" placeholder="TOEFL Score"
                                    class="input input-bordered" value="{{ user_data.academic_info.toefl_score }}">
                            </div>

                            <div class="form-control">
                                <label class="label">IELTS Score</label>
                                <input type="text" name="ielts_score" placeholder="IELTS Score"
                                    class="input input-bordered" value="{{ user_data.academic_info.ielts_score }}">
                            </div>
                        </div>

                        <div class="mt-6">
                            <h3 class="text-xl font-semibold mb-4">Languages</h3>
                            <div id="languagesContainer">
                                {% for language in user_data.academic_info.languages %}
                                <div class="flex gap-4 mb-2">
                                    <input type="text" name="language_name" placeholder="Language"
                                        class="input input-bordered flex-1" value="{{ language.name }}">
                                    <select name="language_level" class="select select-bordered">
                                        <option value="A1" {% if language.level=='A1' %}selected{% endif %}>A1
                                        </option>
                                        <option value="A2" {% if language.level=='A2' %}selected{% endif %}>A2
                                        </option>
                                        <option value="B1" {% if language.level=='B1' %}selected{% endif %}>B1
                                        </option>
                                        <option value="B2" {% if language.level=='B2' %}selected{% endif %}>B2
                                        </option>
                                        <option value="C1" {% if language.level=='C1' %}selected{% endif %}>C1
                                        </option>
                                        <option value="C2" {% if language.level=='C2' %}selected{% endif %}>C2
                                        </option>
                                    </select>
                                    <button type="button" class="btn btn-ghost text-red-500">Remove</button>
                                </div>
                                {% endfor %}
                            </div>
                            <button type="button" id="addLanguageBtn" class="btn bg-black hover:bg-gray-800 text-white">
                                Add Language
                            </button>
                        </div>

                        <div class="mt-6">
                            <h3 class="text-xl font-semibold mb-4">Achievements</h3>
                            <div id="achievementsContainer">
                                {% for achievement in user_data.academic_info.achievements %}
                                <div class="mb-4 p-4 bg-gray-50 rounded-lg">
                                    <input type="text" name="achievement_title" placeholder="Achievement Title"
                                        class="input input-bordered w-full mb-2" value="{{ achievement.title }}">
                                    <textarea name="achievement_description" placeholder="Description"
                                        class="textarea textarea-bordered w-full mb-2">{{ achievement.description }}</textarea>
                                    <input type="date" name="achievement_date" class="input input-bordered"
                                        value="{{ achievement.date }}">
                                    <button type="button" class="btn btn-ghost text-red-500 mt-2">Remove</button>
                                </div>
                                {% endfor %}
                            </div>
                            <button type="button" id="addAchievementBtn"
                                class="btn bg-black hover:bg-gray-800 text-white">
                                Add Achievement
                            </button>
                        </div>
                        <!-- Модальное окно для загрузки -->

                        <div class="form-control mt-6">
                            <button type="submit" class="btn bg-black hover:bg-gray-800 text-white w-full">
                                Save Academic Portfolio
                            </button>
                        </div>
                    </form>
                </div>


            </div>
        </div>
    </div>
    <div id="uploadModal" class="modal">
        <div class="modal-box">
            <h3 class="font-bold text-lg mb-4">Upload Certificate</h3>
            <form id="certificateForm" class="space-y-4">
                <div class="form-control">
                    <label class="label">
                        <span class="label-text">Certificate Title</span>
                    </label>
                    <input type="text" id="certTitle" name="title" class="input input-bordered" required>
                </div>

                <div class="form-control">
                    <label class="label">
                        <span class="label-text">Certificate File</span>
                    </label>
                    <input type="file" name="certificate" accept=".pdf,.jpg,.jpeg,.png"
                        class="file-input file-input-bordered w-full" onchange="previewCertificate(this)" required>
                </div>

                <div id="previewContainer" class="hidden mt-4">
                    <img id="imagePreview" class="max-h-48 mx-auto" alt="Preview">
                </div>

                <div class="modal-action">
                    <button type="submit" class="btn btn-primary">Upload</button>
                    <button type="button" onclick="closeUploadModal()" class="btn">Cancel</button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        // Utility Functions
        const utils = {
            debounce: function (func, delay) {
                let timeoutId;
                return (...args) => {
                    clearTimeout(timeoutId);
                    timeoutId = setTimeout(() => func.apply(null, args), delay);
                };
            },
            showNotification: function (message, type = 'success') {
                const notification = document.createElement('div');
                notification.className = `fixed top-4 right-4 z-50 px-4 py-2 rounded-lg ${type === 'success' ? 'bg-black text-white' : 'bg-red-500 text-white'} transition-opacity duration-300`;
                notification.textContent = message;
                document.body.appendChild(notification);

                setTimeout(() => {
                    notification.style.opacity = '0';
                    setTimeout(() => notification.remove(), 300);
                }, 3000);
            }
        };

        // Avatar Upload Handler
        const avatarHandler = {
            init: function () {
                const avatarInput = document.querySelector('input[name="avatar"]');
                if (avatarInput) {
                    avatarInput.addEventListener('change', this.handleUpload.bind(this));
                }
            },
            handleUpload: async function (event) {
                const file = event.target.files[0];
                if (!file) return;

                const formData = new FormData();
                formData.append('avatar', file);

                try {
                    const response = await fetch('{{ url_for("profile") }}', {
                        method: 'POST',
                        body: formData,
                        headers: { 'X-Requested-With': 'XMLHttpRequest' }
                    });

                    const data = await response.json();
                    if (data.success) {
                        document.getElementById('avatarPreview').src = data.avatar_url;
                        const navAvatars = document.querySelectorAll('.avatar img');
                        navAvatars.forEach(avatar => {
                            avatar.src = data.avatar_url;
                        });
                        utils.showNotification('Avatar updated successfully');
                    } else {
                        utils.showNotification('Failed to update avatar', 'error');
                    }
                } catch (error) {
                    console.error('Error:', error);
                    utils.showNotification('Error updating avatar', 'error');
                }
            }
        };

        // Academic Portfolio Handler
        const academicPortfolioHandler = {
            init: function () {
                this.setupFormListeners();
                this.setupLanguageManagement();
                this.setupAchievementManagement();
            },
            setupFormListeners: function () {
                const academicForm = document.getElementById('academicPortfolioForm');
                if (academicForm) {
                    const scoreFields = ['gpa', 'sat_score', 'toefl_score', 'ielts_score'];
                    scoreFields.forEach(field => {
                        const input = academicForm.querySelector(`[name="${field}"]`);
                        if (input) {
                            input.addEventListener('input', utils.debounce(this.savePortfolio.bind(this), 1000));
                        }
                    });

                    academicForm.addEventListener('submit', async function (e) {
                        e.preventDefault();
                        await academicPortfolioHandler.savePortfolio();
                    });
                }
            },
            setupLanguageManagement: function () {
                const addLanguageBtn = document.getElementById('addLanguageBtn');
                const languagesContainer = document.getElementById('languagesContainer');

                if (addLanguageBtn && languagesContainer) {
                    addLanguageBtn.addEventListener('click', () => {
                        const newLanguageRow = this.createLanguageRow();
                        languagesContainer.appendChild(newLanguageRow);
                    });

                    languagesContainer.addEventListener('input', utils.debounce(this.savePortfolio.bind(this), 1000));
                }
            },
            setupAchievementManagement: function () {
                const addAchievementBtn = document.getElementById('addAchievementBtn');
                const achievementsContainer = document.getElementById('achievementsContainer');

                if (addAchievementBtn && achievementsContainer) {
                    addAchievementBtn.addEventListener('click', () => {
                        const newAchievementRow = this.createAchievementRow();
                        achievementsContainer.appendChild(newAchievementRow);
                    });

                    achievementsContainer.addEventListener('input', utils.debounce(this.savePortfolio.bind(this), 1000));
                }
            },
            createLanguageRow: function () {
                const row = document.createElement('div');
                row.className = 'flex gap-4 mb-2';
                row.innerHTML = `
                <input type="text" name="language_name" placeholder="Language" 
                    class="input input-bordered flex-1">
                <select name="language_level" class="select select-bordered">
                    <option value="A1">A1</option>
                    <option value="A2">A2</option>
                    <option value="B1">B1</option>
                    <option value="B2">B2</option>
                    <option value="C1">C1</option>
                    <option value="C2">C2</option>
                </select>
                <button type="button" class="btn btn-ghost text-red-500">Remove</button>
            `;
                row.querySelector('button').addEventListener('click', () => row.remove());
                return row;
            },
            createAchievementRow: function () {
                const row = document.createElement('div');
                row.className = 'mb-4 p-4 bg-gray-50 rounded-lg';
                row.innerHTML = `
                <input type="text" name="achievement_title" placeholder="Achievement Title" 
                    class="input input-bordered w-full mb-2">
                <textarea name="achievement_description" placeholder="Description" 
                    class="textarea textarea-bordered w-full mb-2"></textarea>
                <input type="date" name="achievement_date" 
                    class="input input-bordered">
                <button type="button" class="btn btn-ghost text-red-500 mt-2">Remove</button>
            `;
                row.querySelector('button').addEventListener('click', () => row.remove());
                return row;
            },
            collectFormData: function () {
                const academicForm = document.getElementById('academicPortfolioForm');
                const data = {
                    gpa: academicForm.querySelector('input[name="gpa"]')?.value || '',
                    sat_score: academicForm.querySelector('input[name="sat_score"]')?.value || '',
                    toefl_score: academicForm.querySelector('input[name="toefl_score"]')?.value || '',
                    ielts_score: academicForm.querySelector('input[name="ielts_score"]')?.value || '',
                    languages: [],
                    achievements: []
                };

                // Собираем языки
                document.querySelectorAll('#languagesContainer > div').forEach(row => {
                    const name = row.querySelector('input[name="language_name"]')?.value.trim();
                    const level = row.querySelector('select[name="language_level"]')?.value;
                    if (name) {
                        data.languages.push({ name, level });
                    }
                });

                // Собираем достижения
                document.querySelectorAll('#achievementsContainer > div').forEach(row => {
                    const title = row.querySelector('input[name="achievement_title"]')?.value.trim();
                    const description = row.querySelector('textarea[name="achievement_description"]')?.value.trim();
                    const date = row.querySelector('input[name="achievement_date"]')?.value;
                    if (title) {
                        data.achievements.push({ title, description, date });
                    }
                });

                console.log('Collected form data:', data);
                return data;
            },
            savePortfolio: async function () {
                const formData = this.collectFormData();

                try {
                    // Получаем CSRF токен
                    const csrf_token = document.querySelector('meta[name="csrf-token"]')?.content;

                    const response = await fetch('/update_academic_portfolio', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Accept': 'application/json',
                            'X-Requested-With': 'XMLHttpRequest',
                            'X-CSRFToken': csrf_token  // Добавляем CSRF токен
                        },
                        credentials: 'same-origin',  // Важно для работы с CSRF
                        body: JSON.stringify(formData)
                    });

                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }

                    const result = await response.json();

                    if (result.success) {
                        utils.showNotification('Academic portfolio updated successfully');
                    } else {
                        utils.showNotification(result.error || 'Error updating portfolio', 'error');
                    }
                } catch (error) {
                    console.error('Error:', error);
                    utils.showNotification('Something went wrong', 'error');
                }
            }
        };


        // Profile Update Handler
        const profileUpdateHandler = {
            init: function () {
                const profileForm = document.getElementById('profileForm');
                if (profileForm) {
                    profileForm.addEventListener('submit', this.handleSubmit.bind(this));
                }
            },
            handleSubmit: async function (e) {
                e.preventDefault();
                const formData = new FormData(e.target);

                try {
                    const response = await fetch('{{ url_for("profile") }}', {
                        method: 'POST',
                        body: formData,
                        headers: { 'X-Requested-With': 'XMLHttpRequest' }
                    });

                    const data = await response.json();
                    if (data.success) {
                        utils.showNotification('Profile updated successfully');
                        location.reload();
                    } else {
                        utils.showNotification('Update failed', 'error');
                    }
                } catch (error) {
                    utils.showNotification('Failed to update profile', 'error');
                }
            }
        };

        // Certificate Management
        const certificateHandler = {
            init: function () {
                this.setupCertificateUpload();
                this.setupCertificateDeletion();
            },
            setupCertificateUpload: function () {
                const certificateForm = document.getElementById('certificateForm');
                if (certificateForm) {
                    certificateForm.addEventListener('submit', async function (e) {
                        e.preventDefault();
                        const formData = new FormData();
                        const title = document.getElementById('certTitle').value;
                        const file = this.querySelector('input[type="file"]').files[0];

                        if (!file) {
                            utils.showNotification('Please select a file', 'error');
                            return;
                        }

                        formData.append('title', title);
                        formData.append('certificate', file);

                        try {
                            const response = await fetch(window.location.href, {
                                method: 'POST',
                                body: formData,
                                headers: { 'X-Requested-With': 'XMLHttpRequest' }
                            });

                            const data = await response.json();
                            if (data.success) {
                                utils.showNotification('Certificate uploaded successfully');
                                closeUploadModal();
                                location.reload();
                            } else {
                                throw new Error(data.error || 'Upload failed');
                            }
                        } catch (error) {
                            console.error('Upload error:', error);
                            utils.showNotification('Failed to upload certificate', 'error');
                        }
                    });
                }
            },
            setupCertificateDeletion: function () {
                window.deleteCertificate = async function (certId) {
                    if (confirm('Are you sure you want to delete this certificate?')) {
                        try {
                            const response = await fetch(`/delete-certificate/${certId}`, {
                                method: 'DELETE',
                            });
                            if (response.ok) {
                                utils.showNotification('Certificate deleted successfully');
                                window.location.reload();
                            } else {
                                throw new Error('Failed to delete certificate');
                            }
                        } catch (error) {
                            utils.showNotification('Error deleting certificate', 'error');
                            console.error('Error:', error);
                        }
                    }
                };
            }
        };

        // Utility Functions
        window.copyProfileLink = function () {
            const profileLink = `{{ request.host_url }}{{ user_data.username }}`;
            navigator.clipboard.writeText(profileLink).then(() => {
                utils.showNotification('Profile link copied to clipboard!');
            }).catch(err => {
                utils.showNotification('Failed to copy link', 'error');
            });
        };

        window.showUploadModal = function () {
            const modal = document.getElementById('uploadModal');
            modal.classList.add('modal-open');
        };

        window.closeUploadModal = function () {
            const modal = document.getElementById('uploadModal');
            modal.classList.remove('modal-open');
            document.getElementById('certificateForm').reset();
            document.getElementById('previewContainer').classList.add('hidden');
        };

        window.previewCertificate = function (input) {
            const previewContainer = document.getElementById('previewContainer');
            const imagePreview = document.getElementById('imagePreview');

            if (input.files && input.files[0]) {
                const file = input.files[0];
                if (file.type.startsWith('image/')) {
                    const reader = new FileReader();
                    reader.onload = function (e) {
                        imagePreview.src = e.target.result;
                        previewContainer.classList.remove('hidden');
                    }
                    reader.readAsDataURL(file);
                } else {
                    previewContainer.classList.add('hidden');
                }
            }
        };

        window.previewImage = function (input) {
            const preview = document.getElementById('avatarPreview');
            const file = input.files[0];
            const reader = new FileReader();

            reader.onloadend = function () {
                preview.src = reader.result;
            }

            if (file) {
                reader.readAsDataURL(file);
            } else {
                preview.src = "{{ avatar_url }}";
            }
        };
        // Main class for handling link management
        // Main class for handling link management
        class LinksManager {
            constructor() {
                this.setupEventListeners();
                this.utils = {
                    showNotification: function (message, type = 'success') {
                        const notification = document.createElement('div');
                        notification.className = `fixed top-4 right-4 z-50 px-4 py-2 rounded-lg ${type === 'success' ? 'bg-black text-white' : 'bg-red-500 text-white'} transition-opacity duration-300`;
                        notification.textContent = message;
                        document.body.appendChild(notification);

                        setTimeout(() => {
                            notification.style.opacity = '0';
                            setTimeout(() => notification.remove(), 300);
                        }, 3000);
                    }
                };
            }

            setupEventListeners() {
                // Form submission handler
                const form = document.getElementById('linksForm');
                if (form) {
                    form.addEventListener('submit', this.handleFormSubmit.bind(this));
                }

                // Add link button handler
                const addLinkBtn = document.querySelector('[onclick="addLink()"]');
                if (addLinkBtn) {
                    addLinkBtn.removeAttribute('onclick');
                    addLinkBtn.addEventListener('click', this.addLink.bind(this));
                }

                // Setup existing link buttons
                document.querySelectorAll('.remove-link-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => this.removeLink(e.target.closest('.link-entry')));
                });

                // Setup existing validate buttons
                document.querySelectorAll('button[onclick="validateUrl(this)"]').forEach(btn => {
                    btn.removeAttribute('onclick');
                    const input = btn.closest('.relative').querySelector('input[type="url"]');
                    btn.addEventListener('click', () => this.validateUrl(input));
                });

                // Setup URL input change handlers
                document.querySelectorAll('input[name="link_urls[]"]').forEach(input => {
                    input.addEventListener('input', () => this.updateLinkIcon(input));
                });
            }

            async handleFormSubmit(e) {
                e.preventDefault();
                const links = this.collectFormData();

                if (!this.validateLinks(links)) {
                    this.utils.showNotification('Please fill in all required fields correctly', 'error');
                    return;
                }

                try {
                    const csrf_token = document.querySelector('input[name="csrf_token"]').value;

                    const response = await fetch('/update-links', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-Requested-With': 'XMLHttpRequest',
                            'X-CSRFToken': csrf_token
                        },
                        credentials: 'same-origin', // Important for cookies/session
                        body: JSON.stringify({ links })
                    });

                    const data = await response.json();

                    if (data.success) {
                        this.utils.showNotification('Links updated successfully');
                        if (data.reload) {
                            window.location.reload();
                        }
                    } else {
                        throw new Error(data.error || 'Failed to update links');
                    }
                } catch (error) {
                    console.error('Error updating links:', error);
                    this.utils.showNotification('Failed to update links', 'error');
                }
            }
            collectFormData() {
                const links = [];
                const entries = document.querySelectorAll('.link-entry');

                entries.forEach(entry => {
                    const titleInput = entry.querySelector('input[name="link_titles[]"]');
                    const urlInput = entry.querySelector('input[name="link_urls[]"]');

                    if (titleInput && urlInput) {
                        links.push({
                            title: titleInput.value.trim(),
                            url: urlInput.value.trim()
                        });
                    }
                });

                return links;
            }

            validateLinks(links) {
                return links.every(link => {
                    if (!link.title || !link.url) return false;
                    try {
                        new URL(link.url);
                        return true;
                    } catch {
                        return false;
                    }
                });
            }

            addLink() {
                const container = document.getElementById('linksContainer');
                if (!container) return;

                const linkEntry = this.createLinkEntry();
                container.appendChild(linkEntry);

                // Animate entry
                requestAnimationFrame(() => {
                    linkEntry.classList.remove('opacity-0');
                });
            }

            createLinkEntry() {
                const div = document.createElement('div');
                div.className = 'link-entry group p-4 bg-gray-50 rounded-xl hover:bg-gray-100 transition-all duration-200 opacity-0';

                div.innerHTML = `
            <div class="flex items-start gap-4">
                <div class="link-icon flex-shrink-0 mt-2">
                    <div class="h-8 w-8 rounded-lg bg-gray-200 flex items-center justify-center">
                        <svg class="h-5 w-5 text-gray-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" 
                                d="M13.828 10.172a4 4 0 00-5.656 0l-4 4a4 4 0 105.656 5.656l1.102-1.101m-.758-4.899a4 4 0 005.656 0l4-4a4 4 0 00-5.656-5.656l-1.1 1.1"/>
                        </svg>
                    </div>
                </div>
                <div class="flex-grow space-y-3">
                    <div class="form-control">
                        <input type="text" name="link_titles[]" placeholder="Link Title" 
                            class="input input-bordered w-full bg-white" required>
                    </div>
                    <div class="form-control">
                        <div class="relative">
                            <input type="url" name="link_urls[]" placeholder="https://example.com" 
                                pattern="https?://.*" class="input input-bordered w-full pr-10 bg-white" required>
                            <button type="button" class="validate-url-btn absolute right-2 top-1/2 -translate-y-1/2 text-gray-400 hover:text-gray-600">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
                                </svg>
                            </button>
                        </div>
                        <span class="text-xs text-gray-500 mt-1">Start with http:// or https://</span>
                    </div>
                </div>
                <div class="flex-shrink-0 space-y-2">
                    <button type="button" class="remove-link-btn btn btn-ghost btn-sm text-red-500 hover:bg-red-50">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" 
                                d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/>
                        </svg>
                    </button>
                </div>
            </div>
        `;

                // Setup event listeners for the new entry
                const urlInput = div.querySelector('input[name="link_urls[]"]');
                const validateButton = div.querySelector('.validate-url-btn');
                const removeButton = div.querySelector('.remove-link-btn');

                validateButton.addEventListener('click', () => this.validateUrl(urlInput));
                removeButton.addEventListener('click', () => this.removeLink(div));
                urlInput.addEventListener('input', () => this.updateLinkIcon(urlInput));

                return div;
            }

            removeLink(linkEntry) {
                if (!linkEntry) return;
                linkEntry.classList.add('opacity-0');
                setTimeout(() => linkEntry.remove(), 200);
            }

            validateUrl(input) {
                if (!input) return;

                const url = input.value.trim();
                if (!url) {
                    this.utils.showNotification('Please enter a URL', 'error');
                    return;
                }

                try {
                    new URL(url);
                    this.utils.showNotification('Valid URL format!', 'success');
                    this.updateLinkIcon(input);
                } catch (e) {
                    this.utils.showNotification('Invalid URL format. Make sure to include http:// or https://', 'error');
                }
            }

            updateLinkIcon(input) {
                if (!input) return;

                const url = input.value.toLowerCase();
                const linkEntry = input.closest('.link-entry');
                if (!linkEntry) return;

                const iconContainer = linkEntry.querySelector('.link-icon');
                if (!iconContainer) return;

                const icons = {
                    'linkedin.com': {
                        color: '#0A66C2',
                        path: 'M19 0h-14c-2.761 0-5 2.239-5 5v14c0 2.761 2.239 5 5 5h14c2.762 0 5-2.239 5-5v-14c0-2.761-2.238-5-5-5zm-11 19h-3v-11h3v11zm-1.5-12.268c-.966 0-1.75-.79-1.75-1.764s.784-1.764 1.75-1.764 1.75.79 1.75 1.764-.783 1.764-1.75 1.764zm13.5 12.268h-3v-5.604c0-3.368-4-3.113-4 0v5.604h-3v-11h3v1.765c1.396-2.586 7-2.777 7 2.476v6.759z'
                    },
                    'github.com': {
                        color: '#181717',
                        path: 'M12 0c-6.626 0-12 5.373-12 12 0 5.302 3.438 9.8 8.207 11.387.599.111.793-.261.793-.577v-2.234c-3.338.726-4.033-1.416-4.033-1.416-.546-1.387-1.333-1.756-1.333-1.756-1.089-.745.083-.729.083-.729 1.205.084 1.839 1.237 1.839 1.237 1.07 1.834 2.807 1.304 3.492.997.107-.775.418-1.305.762-1.604-2.665-.305-5.467-1.334-5.467-5.931 0-1.311.469-2.381 1.236-3.221-.124-.303-.535-1.524.117-3.176 0 0 1.008-.322 3.301 1.23.957-.266 1.983-.399 3.003-.404 1.02.005 2.047.138 3.006.404 2.291-1.552 3.297-1.23 3.297-1.23.653 1.653.242 2.874.118 3.176.77.84 1.235 1.911 1.235 3.221 0 4.609-2.807 5.624-5.479 5.921.43.372.823 1.102.823 2.222v3.293c0 .319.192.694.801.576 4.765-1.589 8.199-6.086 8.199-11.386 0-6.627-5.373-12-12-12z'
                    }
                };

                const platform = Object.keys(icons).find(platform => url.includes(platform));
                let iconHtml;

                if (platform) {
                    const icon = icons[platform];
                    iconHtml = `
                <svg class="h-8 w-8" style="color: ${icon.color}" fill="currentColor" viewBox="0 0 24 24">
                    <path d="${icon.path}"/>
                </svg>
            `;
                } else {
                    iconHtml = `
                <div class="h-8 w-8 rounded-lg bg-gray-200 flex items-center justify-center">
                    <svg class="h-5 w-5 text-gray-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" 
                            d="M13.828 10.172a4 4 0 00-5.656 0l-4 4a4 4 0 105.656 5.656l1.102-1.101m-.758-4.899a4 4 0 005.656 0l4-4a4 4 0 00-5.656-5.656l-1.1 1.1"/>
                    </svg>
                </div>
            `;
                }

                iconContainer.innerHTML = iconHtml;
            }
        }

        // Initialize globally available functions
        window.addLink = function () {
            if (window.linksManager) {
                window.linksManager.addLink();
            }
        };
        // Initialize the links manager when the document is ready
        document.addEventListener('DOMContentLoaded', () => {
            window.linksManager = new LinksManager();
        });
        // Initialize all handlers
        function init() {
            avatarHandler.init();
            academicPortfolioHandler.init();
            window.linksManager = new LinksManager();
            profileUpdateHandler.init();
            certificateHandler.init();
        }

        // Run initialization
        init();
    });

</script>
{% endblock %}