{% extends "base.html" %}
{% block content %}
<div class="min-h-screen bg-gray-50">
    <div class="container mx-auto px-4 py-8">
        <!-- Header Container -->
        <div class="relative w-full mb-8">
            <div
                class="relative w-full h-[400px] overflow-hidden rounded-3xl bg-gradient-to-r from-gray-100 to-gray-200 shadow-lg">
                {% if user_data.header_image %}
                <div class="absolute inset-0 bg-black/10"></div>
                <img src="{{ user_data.header_image.url }}"
                    class="w-full h-full object-cover transition-all duration-300"
                    style="object-position: {{ user_data.header_image.position or '50% 50%' }}" alt="Profile header"
                    id="headerImage">
                {% else %}
                <div class="w-full h-full bg-gradient-to-br from-gray-100 to-gray-200"></div>
                {% endif %}

                {% if session.get('user_id') == user_data.uid %}
                <div class="absolute inset-0 opacity-0 hover:opacity-100 transition-all duration-300">
                    <div class="absolute inset-0 bg-black/30 backdrop-blur-sm"></div>
                    <div class="absolute inset-0 flex items-center justify-center">
                        <label class="cursor-pointer group">
                            <div
                                class="bg-white/90 px-6 py-3 rounded-xl shadow-lg flex items-center gap-3 
                                      group-hover:bg-white transition-colors transform group-hover:scale-105 duration-200">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-gray-700" fill="none"
                                    viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z" />
                                </svg>
                                <span class="font-medium text-gray-900">Change Header</span>
                            </div>
                            <input type="file" id="headerInput" class="hidden" accept="image/*"
                                onchange="handleHeaderUpload(this)">
                        </label>
                    </div>
                </div>
                {% endif %}
            </div>
        </div>

        <!-- Main Content -->
        <div class="max-w-7xl mx-auto">
            <div class="grid grid-cols-1 md:grid-cols-3 gap-8">
                <!-- Left Column -->
                <div class="md:col-span-1 space-y-6">
                    <!-- Profile Card -->
                    <div
                        class="bg-white rounded-2xl shadow-sm p-8 relative transform hover:scale-[1.02] transition-transform duration-300">
                        <div class="relative group w-40 h-40 mx-auto mb-6">
                            <img id="avatarPreview" src="{{ avatar_url }}"
                                class="w-full h-full object-cover rounded-2xl shadow-md" alt="Profile picture">
                            <label
                                class="absolute inset-0 rounded-2xl bg-black bg-opacity-50 opacity-0 group-hover:opacity-100 flex items-center justify-center cursor-pointer transition-opacity">
                                <span class="text-white text-sm font-medium">Change Photo</span>
                                <input type="file" name="avatar" accept="image/*" class="hidden"
                                    onchange="previewImage(this)">
                            </label>
                        </div>

                        <!-- Profile Info -->
                        <div class="text-center md:text-left space-y-4">
                            <div class="flex items-center justify-center md:justify-start gap-4">
                                <h1 class="text-3xl font-bold gradient-text">
                                    {{ user_data.full_name if user_data and user_data.full_name else 'Your Name' }}
                                </h1>
                                {% if user_data.verified %}
                                <div class="tooltip"
                                    data-tip="{{ 'Officially verified account' if user_data.verification_type == 'official' else 'Verified account' }}">
                                    <svg xmlns="http://www.w3.org/2000/svg"
                                        class="h-6 w-6 text-blue-500 transition-all duration-300 transform hover:scale-110 hover:rotate-6"
                                        viewBox="0 0 20 20" fill="currentColor">
                                        <path fill-rule="evenodd"
                                            d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z"
                                            clip-rule="evenodd" />
                                    </svg>
                                </div>
                                {% endif %}
                            </div>

                            <p class="text-gray-600 flex items-center justify-center md:justify-start gap-2">
                                @{{ user_data.username if user_data else '' }}
                                <button onclick="copyProfileLink()"
                                    class="btn btn-ghost btn-sm p-1 hover:bg-gray-100 rounded-lg"
                                    title="Copy Profile Link">
                                    <svg xmlns="http://www.w3.org/2000/svg"
                                        class="h-5 w-5 text-gray-500 hover:text-black transition-colors" fill="none"
                                        viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                            d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z" />
                                    </svg>
                                </button>
                            </p>

                            <div class="flex flex-wrap justify-center md:justify-start gap-2 mt-4">
                                <span
                                    class="px-4 py-2 bg-gray-100 rounded-full text-sm font-medium hover:bg-gray-200 transition-colors">
                                    {{ certificates|length }} Certificates
                                </span>
                                <span
                                    class="px-4 py-2 bg-gray-100 rounded-full text-sm font-medium hover:bg-gray-200 transition-colors">
                                    Member since {{ user_data.created_at.strftime('%B %Y') if user_data and
                                    user_data.created_at else 'Recently' }}
                                </span>
                            </div>
                        </div>
                    </div>

                    <!-- Profile Information Form -->
                    <div class="bg-white rounded-2xl shadow-sm p-8 space-y-6">
                        <h2 class="text-2xl font-bold mb-6">Profile Information</h2>
                        <form method="POST" enctype="multipart/form-data" id="profileForm" class="space-y-6">
                            <!-- Form Fields -->
                            <div class="space-y-4">
                                <div class="form-control">
                                    <label class="label font-medium text-gray-700">Full Name</label>
                                    <input type="text" name="full_name"
                                        class="input input-bordered bg-gray-50 w-full focus:ring-2 focus:ring-black transition-all"
                                        value="{{ user_data.full_name if user_data else '' }}">
                                </div>

                                <div class="form-control">
                                    <label class="label font-medium text-gray-700">Age</label>
                                    <input type="number" name="age" min="13" max="120"
                                        class="input input-bordered bg-gray-50 w-full focus:ring-2 focus:ring-black transition-all"
                                        value="{{ user_data.age if user_data else '' }}" placeholder="Enter your age">
                                </div>

                                <div class="form-control">
                                    <label class="label font-medium text-gray-700">Specialty</label>
                                    <input type="text" name="specialty"
                                        class="input input-bordered bg-gray-50 w-full focus:ring-2 focus:ring-black transition-all"
                                        value="{{ user_data.specialty if user_data else '' }}"
                                        placeholder="e.g., Computer Science, Medicine, Art">
                                </div>

                                <div class="form-control">
                                    <label class="label font-medium text-gray-700">Goals</label>
                                    <textarea name="goals"
                                        class="textarea textarea-bordered bg-gray-50 w-full min-h-[100px] focus:ring-2 focus:ring-black transition-all"
                                        placeholder="What are your academic or professional goals?">{{ user_data.goals if user_data else '' }}</textarea>
                                </div>

                                <div class="form-control">
                                    <label class="label font-medium text-gray-700">Bio</label>
                                    <textarea name="bio"
                                        class="textarea textarea-bordered bg-gray-50 w-full min-h-[100px] focus:ring-2 focus:ring-black transition-all">{{ user_data.bio if user_data else '' }}</textarea>
                                </div>

                                <!-- Skills Section -->
                                <div class="space-y-4">
                                    <div class="flex items-center justify-between">
                                        <h3 class="text-lg font-medium text-gray-900">Skills</h3>
                                        <button onclick="showSkillsEditor()" type="button"
                                            class="text-sm text-purple-600 hover:text-purple-800 font-medium">
                                            Edit Skills
                                        </button>
                                    </div>
                                    <div class="flex flex-wrap gap-2" id="skillsContainer">
                                        {% for skill in user_data.skills %}
                                        <span
                                            class="px-3 py-1 text-sm font-medium bg-purple-50 text-purple-700 rounded-full hover:bg-purple-100 transition-colors">
                                            {{ skill }}
                                        </span>
                                        {% endfor %}
                                    </div>
                                </div>

                                <!-- Location Section -->
                                <div class="space-y-2">
                                    <h3 class="text-lg font-medium text-gray-900">Location</h3>
                                    {% if user_data.location %}
                                    <div class="flex items-center gap-2 text-gray-600 bg-gray-50 p-3 rounded-lg">
                                        <svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                                d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z" />
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                                d="M15 11a3 3 0 11-6 0 3 3 0 016 0z" />
                                        </svg>
                                        <span data-location class="font-medium">
                                            {{ user_data.location.city }}, {{ user_data.location.country }}
                                        </span>
                                    </div>
                                    {% else %}
                                    <div class="text-gray-500 text-sm bg-gray-50 p-3 rounded-lg">
                                        Location not available
                                    </div>
                                    {% endif %}
                                </div>

                                <div class="form-control">
                                    <label class="label font-medium text-gray-700">Education</label>
                                    <textarea name="education"
                                        class="textarea textarea-bordered bg-gray-50 w-full focus:ring-2 focus:ring-black transition-all">{{ user_data.education if user_data else '' }}</textarea>
                                </div>

                                <button type="submit"
                                    class="btn bg-black hover:bg-gray-800 text-white w-full transform hover:scale-[1.02] transition-all duration-200">
                                    Save Changes
                                </button>
                            </div>
                        </form>
                    </div>

                    <!-- Links & Contacts -->
                    <div class="bg-white rounded-2xl shadow-sm p-8 space-y-6">
                        <h2 class="text-2xl font-bold mb-6">Your Links & Contacts</h2>
                        <form id="linksForm" class="space-y-6">
                            <div id="linksContainer" class="space-y-4">
                                {% if user_data.links %}
                                {% for link in user_data.links %}
                                <div
                                    class="link-entry group p-4 bg-gray-50 rounded-xl hover:bg-gray-100 transition-all duration-200">
                                    <div class="flex items-start gap-4">
                                        <div class="link-icon flex-shrink-0 mt-2">
                                            {% if 'linkedin.com' in link.url %}
                                            <svg class="h-8 w-8 text-blue-600" fill="currentColor" viewBox="0 0 24 24">
                                                <path
                                                    d="M19 0h-14c-2.761 0-5 2.239-5 5v14c0 2.761 2.239 5 5 5h14c2.762 0 5-2.239 5-5v-14c0-2.761-2.238-5-5-5zm-11 19h-3v-11h3v11zm-1.5-12.268c-.966 0-1.75-.79-1.75-1.764s.784-1.764 1.75-1.764 1.75.79 1.75 1.764-.783 1.764-1.75 1.764zm13.5 12.268h-3v-5.604c0-3.368-4-3.113-4 0v5.604h-3v-11h3v1.765c1.396-2.5867-2.777 7 2.476v6.759z" />
                                            </svg>
                                            {% elif 'github.com' in link.url %}
                                            <svg class="h-8 w-8 text-gray-900" fill="currentColor" viewBox="0 0 24 24">
                                                <path
                                                    d="M12 0c-6.626 0-12 5.373-12 12 0 5.302 3.438 9.8 8.207 11.387.599.111.793-.261.793-.577v-2.234c-3.338.726-4.033-1.416-4.033-1.416-.546-1.387-1.333-1.756-1.333-1.756-1.089-.745.083-.729.083-.729 1.205.084 1.839 1.237 1.839 1.237 1.07 1.834 2.807 1.304 3.492.997.107-.775.418-1.305.762-1.604-2.665-.305-5.467-1.334-5.467-5.931 0-1.311.469-2.381 1.236-3.221-.124-.303-.535-1.524.117-3.176 0 0 1.008-.322 3.301 1.23.957-.266 1.983-.399 3.003-.404 1.02.005 2.047.138 3.006.404 2.291-1.552 3.297-1.23 3.297-1.23.653 1.653.242 2.874.118 3.176.77.84 1.235 1.911 1.235 3.221 0 4.609-2.807 5.624-5.479 5.921.43.372.823 1.102.823 2.222v3.293c0 .319.192.694.801.576 4.765-1.589 8.199-6.086 8.199-11.386 0-6.627-5.373-12-12-12z" />
                                            </svg>
                                            {% elif 'youtube.com' in link.url or 'youtu.be' in link.url %}
                                            <svg class="h-8 w-8 text-red-600" fill="currentColor" viewBox="0 0 24 24">
                                                <path
                                                    d="M19.615 3.184c-3.604-.246-11.631-.245-15.23 0-3.897.266-4.356 2.62-4.385 8.816.029 6.185.484 8.549 4.385 8.816 3.6.245 11.626.246 15.23 0 3.897-.266 4.356-2.62 4.385-8.816-.029-6.185-.484-8.549-4.385-8.816zm-10.615 12.816v-8l8 3.993-8 4.007z" />
                                            </svg>
                                            {% else %}
                                            <svg class="h-8 w-8 text-gray-500" fill="none" viewBox="0 0 24 24"
                                                stroke="currentColor">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                                    d="M13.828 10.172a4 4 0 00-5.656 0l-4 4a4 4 0 105.656 5.656l1.102-1.101m-.758-4.899a4 4 0 005.656 0l4-4a4 4 0 00-5.656-5.656l-1.1 1.1" />
                                            </svg>
                                            {% endif %}
                                        </div>
                                        <div class="flex-grow space-y-3">
                                            <input type="text" name="link_titles[]" placeholder="Link Title"
                                                class="input input-bordered w-full bg-white focus:ring-2 focus:ring-black transition-all"
                                                value="{{ link.title }}">
                                            <input type="text" name="link_urls[]" placeholder="URL"
                                                class="input input-bordered w-full bg-white focus:ring-2 focus:ring-black transition-all"
                                                value="{{ link.url }}">
                                        </div>
                                        <div class="flex-shrink-0 flex items-start space-x-2">
                                            <a href="{{ link.url }}" target="_blank"
                                                class="btn btn-ghost btn-sm p-2 hover:bg-purple-50 text-purple-600 transition-colors rounded-lg">
                                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none"
                                                    viewBox="0 0 24 24" stroke="currentColor">
                                                    <path stroke-linecap="round" stroke-linejoin="round"
                                                        stroke-width="2"
                                                        d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14" />
                                                </svg>
                                            </a>
                                            <button type="button" onclick="removeLink(this)"
                                                class="btn btn-ghost btn-sm p-2 hover:bg-red-50 text-red-500 transition-colors rounded-lg">
                                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none"
                                                    viewBox="0 0 24 24" stroke="currentColor">
                                                    <path stroke-linecap="round" stroke-linejoin="round"
                                                        stroke-width="2"
                                                        d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                                                </svg>
                                            </button>
                                        </div>
                                    </div>
                                </div>
                                {% endfor %}
                                {% endif %}
                            </div>
                            <div class="flex justify-end space-x-4">
                                <button type="button" onclick="addLink()"
                                    class="btn btn-ghost text-purple-600 hover:bg-purple-50 transition-colors px-6">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none"
                                        viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                            d="M12 4v16m8-8H4" />
                                    </svg>
                                    Add Link
                                </button>
                                <button type="submit"
                                    class="btn bg-black text-white hover:bg-gray-800 transition-colors px-6 transform hover:scale-[1.02] duration-200">
                                    Save Changes
                                </button>
                            </div>
                        </form>
                    </div>
                </div>

                <!-- Right Column -->
                <div class="md:col-span-2 space-y-8">
                    <!-- Certificates Section -->
                    <div class="bg-white rounded-2xl shadow-sm p-8">
                        <div class="flex justify-between items-center mb-6">
                            <h2 class="text-2xl font-bold">Certificates</h2>
                            <button onclick="showUploadModal()"
                                class="btn bg-black hover:bg-gray-800 text-white transform hover:scale-[1.02] transition-all duration-200">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none"
                                    viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M12 4v16m8-8H4" />
                                </svg>
                                Add Certificate
                            </button>
                        </div>

                        {% if certificates %}
                        <div class="grid grid-cols-1 sm:grid-cols-2 gap-6">
                            {% for cert_doc in certificates %}
                            {% set cert = cert_doc.to_dict() %}
                            <div
                                class="group relative bg-gray-50 rounded-xl overflow-hidden hover:shadow-md transition-all duration-300">
                                {% if cert.file_url and (cert.file_url.endswith('.jpg') or
                                cert.file_url.endswith('.jpeg') or cert.file_url.endswith('.png')) %}
                                <div class="relative h-48">
                                    <img src="{{ cert.file_url }}" alt="{{ cert.title }}"
                                        class="w-full h-full object-cover transition-transform duration-300 group-hover:scale-105">
                                    <div
                                        class="absolute inset-0 bg-gradient-to-t from-black/60 to-transparent opacity-0 group-hover:opacity-100 transition-opacity duration-300">
                                    </div>
                                </div>
                                {% else %}
                                <div
                                    class="h-48 flex items-center justify-center bg-gray-100 group-hover:bg-gray-200 transition-colors duration-300">
                                    <svg class="h-16 w-16 text-gray-400" fill="none" viewBox="0 0 24 24"
                                        stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                            d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                                    </svg>
                                </div>
                                {% endif %}

                                <div class="p-6 space-y-4">
                                    <h3
                                        class="text-lg font-semibold text-gray-900 group-hover:text-black transition-colors">
                                        {{ cert.title }}
                                    </h3>
                                    {% if cert.uploaded_at %}
                                    <p class="text-sm text-gray-500">
                                        {{ cert.uploaded_at.strftime('%B %d, %Y') }}
                                    </p>
                                    {% endif %}
                                    <div class="flex justify-between items-center">
                                        <a href="{{ cert.file_url }}" target="_blank"
                                            class="btn btn-sm bg-black hover:bg-gray-800 text-white transform hover:scale-[1.02] transition-all duration-200">
                                            View Certificate
                                        </a>
                                        <button onclick="deleteCertificate('{{ cert_doc.id }}')"
                                            class="btn btn-sm btn-ghost text-red-500 hover:bg-red-50 transition-colors">
                                            Delete
                                        </button>
                                    </div>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                        {% else %}
                        <div class="text-center py-12 bg-gray-50 rounded-xl">
                            <svg class="mx-auto h-12 w-12 text-gray-400" fill="none" viewBox="0 0 24 24"
                                stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M9 13h6m-3-3v6m5 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                            </svg>
                            <h3 class="mt-4 text-lg font-medium text-gray-900">No certificates yet</h3>
                            <p class="mt-2 text-sm text-gray-500">Add your first certificate to showcase your
                                achievements</p>
                            <button onclick="showUploadModal()"
                                class="mt-6 btn bg-black hover:bg-gray-800 text-white transform hover:scale-[1.02] transition-all duration-200">
                                Add Certificate
                            </button>
                        </div>
                        {% endif %}
                    </div>

                    <!-- Academic Portfolio -->
                    <div class="bg-white rounded-2xl shadow-sm p-8">
                        <h2 class="text-2xl font-bold mb-8">Academic Portfolio</h2>
                        <form id="academicPortfolioForm" class="space-y-8">
                            <!-- Academic Scores -->
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                <div class="form-control">
                                    <label class="label font-medium text-gray-700">GPA</label>
                                    <input type="text" name="gpa" placeholder="Enter your GPA"
                                        class="input input-bordered bg-gray-50 w-full focus:ring-2 focus:ring-black transition-all"
                                        value="{{ user_data.academic_info.gpa }}">
                                </div>

                                <div class="form-control">
                                    <label class="label font-medium text-gray-700">SAT Score</label>
                                    <input type="text" name="sat_score" placeholder="Enter SAT Score"
                                        class="input input-bordered bg-gray-50 w-full focus:ring-2 focus:ring-black transition-all"
                                        value="{{ user_data.academic_info.sat_score }}">
                                </div>

                                <div class="form-control">
                                    <label class="label font-medium text-gray-700">TOEFL Score</label>
                                    <input type="text" name="toefl_score" placeholder="TOEFL Score"
                                        class="input input-bordered bg-gray-50 w-full focus:ring-2 focus:ring-black transition-all"
                                        value="{{ user_data.academic_info.toefl_score }}">
                                </div>

                                <div class="form-control">
                                    <label class="label font-medium text-gray-700">IELTS Score</label>
                                    <input type="text" name="ielts_score" placeholder="IELTS Score"
                                        class="input input-bordered bg-gray-50 w-full focus:ring-2 focus:ring-black transition-all"
                                        value="{{ user_data.academic_info.ielts_score }}">
                                </div>
                            </div>

                            <!-- Languages Section -->
                            <div class="space-y-6">
                                <h3 class="text-xl font-semibold">Languages</h3>
                                <div id="languagesContainer" class="space-y-4">
                                    {% for language in user_data.academic_info.languages %}
                                    <div
                                        class="flex gap-4 p-4 bg-gray-50 rounded-xl hover:bg-gray-100 transition-all duration-200">
                                        <input type="text" name="language_name" placeholder="Language"
                                            class="input input-bordered flex-1 bg-white focus:ring-2 focus:ring-black transition-all"
                                            value="{{ language.name }}">
                                        <select name="language_level"
                                            class="select select-bordered bg-white focus:ring-2 focus:ring-black transition-all">
                                            <option value="A1" {% if language.level=='A1' %}selected{% endif %}>A1 -
                                                Beginner</option>
                                            <option value="A2" {% if language.level=='A2' %}selected{% endif %}>A2 -
                                                Elementary</option>
                                            <option value="B1" {% if language.level=='B1' %}selected{% endif %}>B1 -
                                                Intermediate</option>
                                            <option value="B2" {% if language.level=='B2' %}selected{% endif %}>B2 -
                                                Upper Intermediate</option>
                                            <option value="C1" {% if language.level=='C1' %}selected{% endif %}>C1 -
                                                Advanced</option>
                                            <option value="C2" {% if language.level=='C2' %}selected{% endif %}>C2 -
                                                Mastery</option>
                                        </select>
                                        <button type="button"
                                            class="btn btn-ghost text-red-500 hover:bg-red-50 transition-colors">
                                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none"
                                                viewBox="0 0 24 24" stroke="currentColor">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                                    d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                                            </svg>
                                        </button>
                                    </div>
                                    {% endfor %}
                                </div>
                                <button type="button" id="addLanguageBtn"
                                    class="btn bg-black hover:bg-gray-800 text-white transform hover:scale-[1.02] transition-all duration-200">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none"
                                        viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                            d="M12 4v16m8-8H4" />
                                    </svg>
                                    Add Language
                                </button>
                            </div>

                            <!-- Achievements Section -->
                            <div class="space-y-6">
                                <h3 class="text-xl font-semibold">Achievements</h3>
                                <div id="achievementsContainer" class="space-y-4">
                                    {% for achievement in user_data.academic_info.achievements %}
                                    <div
                                        class="p-6 bg-gray-50 rounded-xl hover:bg-gray-100 transition-all duration-200">
                                        <div class="space-y-4">
                                            <input type="text" name="achievement_title" placeholder="Achievement Title"
                                                class="input input-bordered w-full bg-white focus:ring-2 focus:ring-black transition-all"
                                                value="{{ achievement.title }}">
                                            <textarea name="achievement_description" placeholder="Description"
                                                class="textarea textarea-bordered w-full bg-white focus:ring-2 focus:ring-black transition-all min-h-[100px]">{{ achievement.description }}</textarea>
                                            <div class="flex items-center justify-between">
                                                <input type="date" name="achievement_date"
                                                    class="input input-bordered bg-white focus:ring-2 focus:ring-black transition-all"
                                                    value="{{ achievement.date }}">
                                                <button type="button"
                                                    class="btn btn-ghost text-red-500 hover:bg-red-50 transition-colors">
                                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none"
                                                        viewBox="0 0 24 24" stroke="currentColor">
                                                        <path stroke-linecap="round" stroke-linejoin="round"
                                                            stroke-width="2"
                                                            d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                                                    </svg>
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                    {% endfor %}
                                </div>
                                <button type="button" id="addAchievementBtn"
                                    class="btn bg-black hover:bg-gray-800 text-white transform hover:scale-[1.02] transition-all duration-200">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none"
                                        viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                            d="M12 4v16m8-8H4" />
                                    </svg>
                                    Add Achievement
                                </button>
                            </div>

                            <button type="submit"
                                class="btn bg-black hover:bg-gray-800 text-white w-full transform hover:scale-[1.02] transition-all duration-200">
                                Save Academic Portfolio
                            </button>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modals -->
<!-- Upload Certificate Modal -->
<div id="uploadModal" class="modal">
    <div class="modal-box max-w-2xl p-8 relative">
        <h3 class="text-2xl font-bold mb-6">Upload Certificate</h3>
        <form id="certificateForm" class="space-y-6">
            <div class="form-control">
                <label class="label font-medium text-gray-700">Certificate Title</label>
                <input type="text" id="certTitle" name="title"
                    class="input input-bordered bg-gray-50 w-full focus:ring-2 focus:ring-black transition-all"
                    required>
            </div>

            <div class="form-control">
                <label class="label font-medium text-gray-700">Certificate File</label>
                <div class="relative">
                    <input type="file" name="certificate" accept=".pdf,.jpg,.jpeg,.png"
                        class="file-input file-input-bordered w-full bg-gray-50 focus:ring-2 focus:ring-black transition-all"
                        onchange="previewCertificate(this)" required>
                </div>
            </div>

            <div id="previewContainer" class="hidden mt-4">
                <img id="imagePreview" class="max-h-48 mx-auto rounded-lg" alt="Preview">
            </div>

            <div class="flex justify-end gap-4 mt-8">
                <button type="button" onclick="closeUploadModal()"
                    class="btn btn-ghost hover:bg-gray-100 transition-colors">Cancel</button>
                <button type="submit"
                    class="btn bg-black hover:bg-gray-800 text-white transform hover:scale-[1.02] transition-all duration-200">
                    Upload Certificate
                </button>
            </div>
        </form>
    </div>
</div>

<!-- Skills Editor Modal -->
<div id="skillsModal" class="modal">
    <div class="modal-box max-w-2xl p-8">
        <h3 class="text-2xl font-bold mb-6">Edit Skills</h3>
        <div class="space-y-6">
            <div id="skillsList" class="space-y-4">
                <!-- Skills will be added here -->
            </div>
            <button type="button" onclick="addNewSkill(event)"
                class="btn btn-ghost text-purple-600 hover:bg-purple-50 transition-colors">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24"
                    stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
                </svg>
                Add Skill
            </button>
        </div>
        <div class="flex justify-end gap-4 mt-8">
            <button type="button" onclick="closeSkillsModal(event)"
                class="btn btn-ghost hover:bg-gray-100 transition-colors">Cancel</button>
            <button type="button" onclick="saveSkills(event)"
                class="btn bg-black hover:bg-gray-800 text-white transform hover:scale-[1.02] transition-all duration-200">
                Save Changes
            </button>
        </div>
    </div>
</div>

<!-- Header Editor Modal -->
<div id="headerEditorModal" class="modal">
    <div class="modal-box max-w-4xl p-8 bg-white rounded-2xl shadow-2xl">
        <h3 class="text-2xl font-bold mb-6 text-gray-900">Customize Header Image</h3>

        <!-- Превью-контейнер с макетами -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
            <div class="bg-gray-50 rounded-xl p-4">
                <h4 class="text-sm font-medium text-gray-600 mb-3">Desktop Preview</h4>
                <div class="aspect-[4/1] rounded-lg overflow-hidden relative">
                    <img id="desktopHeaderPreview" src="" class="absolute w-full h-full object-cover">
                </div>
            </div>
            <div class="bg-gray-50 rounded-xl p-4">
                <h4 class="text-sm font-medium text-gray-600 mb-3">Mobile Preview</h4>
                <div class="aspect-[3/2] rounded-lg overflow-hidden relative">
                    <img id="mobileHeaderPreview" src="" class="absolute w-full h-full object-cover">
                </div>
            </div>
        </div>

        <!-- Слайдеры с улучшенным дизайном -->
        <div class="space-y-6">
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">
                    Horizontal Position
                </label>
                <input type="range" id="xPosition" min="0" max="100" value="50"
                    class="w-full h-3 bg-gray-200 rounded-full appearance-none cursor-pointer">
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">
                    Vertical Position
                </label>
                <input type="range" id="yPosition" min="0" max="100" value="50"
                    class="w-full h-3 bg-gray-200 rounded-full appearance-none cursor-pointer">
            </div>
        </div>

        <!-- Кнопки с современным дизайном -->
        <div class="flex justify-end space-x-4 mt-8">
            <button onclick="closeHeaderEditor()"
                class="px-6 py-2 bg-gray-100 text-gray-800 rounded-lg hover:bg-gray-200 transition-colors">
                Cancel
            </button>
            <button onclick="saveHeaderImage()"
                class="px-6 py-2 bg-black text-white rounded-lg hover:bg-gray-800 transition-colors">
                Save Changes
            </button>
        </div>
    </div>
</div>


<script>
    document.addEventListener('DOMContentLoaded', function () {
        // Utility Functions
        const utils = {
            debounce: function (func, delay) {
                let timeoutId;
                return (...args) => {
                    clearTimeout(timeoutId);
                    timeoutId = setTimeout(() => func.apply(null, args), delay);
                };
            },
            showNotification: function (message, type = 'success') {
                const notification = document.createElement('div');
                notification.className = `fixed top-4 right-4 z-50 px-4 py-2 rounded-lg ${type === 'success' ? 'bg-black text-white' : 'bg-red-500 text-white'} transition-opacity duration-300`;
                notification.textContent = message;
                document.body.appendChild(notification);

                setTimeout(() => {
                    notification.style.opacity = '0';
                    setTimeout(() => notification.remove(), 300);
                }, 3000);
            }
        };

        // Avatar Upload Handler
        const avatarHandler = {
            init: function () {
                const avatarInput = document.querySelector('input[name="avatar"]');
                if (avatarInput) {
                    avatarInput.addEventListener('change', this.handleUpload.bind(this));
                }
            },
            handleUpload: async function (event) {
                const file = event.target.files[0];
                if (!file) return;

                const formData = new FormData();
                formData.append('avatar', file);

                try {
                    const response = await fetch('{{ url_for("profile") }}', {
                        method: 'POST',
                        body: formData,
                        headers: { 'X-Requested-With': 'XMLHttpRequest' }
                    });

                    const data = await response.json();
                    if (data.success) {
                        document.getElementById('avatarPreview').src = data.avatar_url;
                        const navAvatars = document.querySelectorAll('.avatar img');
                        navAvatars.forEach(avatar => {
                            avatar.src = data.avatar_url;
                        });
                        utils.showNotification('Avatar updated successfully');
                    } else {
                        utils.showNotification('Failed to update avatar', 'error');
                    }
                } catch (error) {
                    console.error('Error:', error);
                    utils.showNotification('Error updating avatar', 'error');
                }
            }
        };

        // Academic Portfolio Handler
        const academicPortfolioHandler = {
            init: function () {
                this.setupFormListeners();
                this.setupLanguageManagement();
                this.setupAchievementManagement();
            },
            setupFormListeners: function () {
                const academicForm = document.getElementById('academicPortfolioForm');
                if (academicForm) {
                    const scoreFields = ['gpa', 'sat_score', 'toefl_score', 'ielts_score'];
                    scoreFields.forEach(field => {
                        const input = academicForm.querySelector(`[name="${field}"]`);
                        if (input) {
                            input.addEventListener('input', utils.debounce(this.savePortfolio.bind(this), 1000));
                        }
                    });

                    academicForm.addEventListener('submit', async function (e) {
                        e.preventDefault();
                        await academicPortfolioHandler.savePortfolio();
                    });
                }
            },
            setupLanguageManagement: function () {
                const addLanguageBtn = document.getElementById('addLanguageBtn');
                const languagesContainer = document.getElementById('languagesContainer');

                if (addLanguageBtn && languagesContainer) {
                    addLanguageBtn.addEventListener('click', () => {
                        const newLanguageRow = this.createLanguageRow();
                        languagesContainer.appendChild(newLanguageRow);
                    });

                    languagesContainer.addEventListener('input', utils.debounce(this.savePortfolio.bind(this), 1000));
                }
            },
            setupAchievementManagement: function () {
                const addAchievementBtn = document.getElementById('addAchievementBtn');
                const achievementsContainer = document.getElementById('achievementsContainer');

                if (addAchievementBtn && achievementsContainer) {
                    addAchievementBtn.addEventListener('click', () => {
                        const newAchievementRow = this.createAchievementRow();
                        achievementsContainer.appendChild(newAchievementRow);
                    });

                    achievementsContainer.addEventListener('input', utils.debounce(this.savePortfolio.bind(this), 1000));
                }
            },
            createLanguageRow: function () {
                const row = document.createElement('div');
                row.className = 'flex gap-4 mb-2';
                row.innerHTML = `
                <input type="text" name="language_name" placeholder="Language" 
                    class="input input-bordered flex-1">
                <select name="language_level" class="select select-bordered">
                    <option value="A1">A1</option>
                    <option value="A2">A2</option>
                    <option value="B1">B1</option>
                    <option value="B2">B2</option>
                    <option value="C1">C1</option>
                    <option value="C2">C2</option>
                </select>
                <button type="button" class="btn btn-ghost text-red-500">Remove</button>
            `;
                row.querySelector('button').addEventListener('click', () => row.remove());
                return row;
            },
            createAchievementRow: function () {
                const row = document.createElement('div');
                row.className = 'mb-4 p-4 bg-gray-50 rounded-lg';
                row.innerHTML = `
                <input type="text" name="achievement_title" placeholder="Achievement Title" 
                    class="input input-bordered w-full mb-2">
                <textarea name="achievement_description" placeholder="Description" 
                    class="textarea textarea-bordered w-full mb-2"></textarea>
                <input type="date" name="achievement_date" 
                    class="input input-bordered">
                <button type="button" class="btn btn-ghost text-red-500 mt-2">Remove</button>
            `;
                row.querySelector('button').addEventListener('click', () => row.remove());
                return row;
            },
            collectFormData: function () {
                const academicForm = document.getElementById('academicPortfolioForm');
                const formData = {
                    gpa: academicForm.querySelector('input[name="gpa"]').value,
                    sat_score: academicForm.querySelector('input[name="sat_score"]').value,
                    toefl_score: academicForm.querySelector('input[name="toefl_score"]').value,
                    ielts_score: academicForm.querySelector('input[name="ielts_score"]').value,
                    languages: [],
                    achievements: []
                };

                document.querySelectorAll('#languagesContainer > div').forEach(row => {
                    const name = row.querySelector('input[name="language_name"]').value;
                    const level = row.querySelector('select[name="language_level"]').value;
                    if (name) formData.languages.push({ name, level });
                });

                document.querySelectorAll('#achievementsContainer > div').forEach(row => {
                    const title = row.querySelector('input[name="achievement_title"]').value;
                    const description = row.querySelector('textarea[name="achievement_description"]').value;
                    const date = row.querySelector('input[name="achievement_date"]').value;
                    if (title) formData.achievements.push({ title, description, date });
                });

                return formData;
            },
            savePortfolio: async function () {
                const formData = this.collectFormData();

                try {
                    const response = await fetch('/update_academic_portfolio', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Accept': 'application/json'
                        },
                        body: JSON.stringify(formData)
                    });

                    const result = await response.json();
                    if (result.success) {
                        utils.showNotification('Academic portfolio updated successfully');
                    } else {
                        utils.showNotification(result.error || 'Error updating portfolio', 'error');
                    }
                } catch (error) {
                    console.error('Error:', error);
                    utils.showNotification('Something went wrong', 'error');
                }
            }
        };

        // Links Management
        const linksHandler = {
            init: function () {
                this.setupLinkManagement();
                this.setupLinksSubmission();
            },
            setupLinkManagement: function () {
                const addLinkBtn = document.querySelector('[onclick="addLink()"]');
                const linksContainer = document.getElementById('linksContainer');

                if (addLinkBtn && linksContainer) {
                    addLinkBtn.addEventListener('click', () => {
                        const linkEntry = this.createLinkEntry();
                        linksContainer.appendChild(linkEntry);
                    });
                }

                // Добавляем функцию removeLink в глобальную область видимости
                window.removeLink = function (button) {
                    const linkEntry = button.closest('.link-entry');
                    if (linkEntry) {
                        linkEntry.remove();
                    }
                };
            },


            createLinkEntry: function () {
                const linkEntry = document.createElement('div');
                linkEntry.className = 'link-entry group flex items-center gap-2';
                linkEntry.innerHTML = `
                <input type="text" name="link_titles[]" placeholder="Link Title" 
                    class="input input-bordered flex-1">
                <input type="text" name="link_urls[]" placeholder="URL" 
                    class="input input-bordered flex-1">
                <button type="button" class="btn btn-ghost text-red-500">Remove</button>
            `;
                linkEntry.querySelector('button').addEventListener('click', () => linkEntry.remove());
                return linkEntry;
            },
            setupLinksSubmission: function () {
                const linksForm = document.getElementById('linksForm');
                if (linksForm) {
                    linksForm.addEventListener('submit', async function (e) {
                        e.preventDefault();
                        const titles = Array.from(this.querySelectorAll('input[name="link_titles[]"]')).map(input => input.value.trim());
                        const urls = Array.from(this.querySelectorAll('input[name="link_urls[]"]')).map(input => input.value.trim());

                        const links = titles.map((title, index) => ({
                            title: title,
                            url: urls[index]
                        })).filter(link => link.title && link.url);

                        try {
                            const response = await fetch('{{ url_for("profile") }}', {
                                method: 'POST',
                                headers: {
                                    'Content-Type': 'application/json',
                                    'X-Requested-With': 'XMLHttpRequest'
                                },
                                body: JSON.stringify({
                                    action: 'update_links',
                                    links: links
                                })
                            });

                            const data = await response.json();
                            if (data.success) {
                                utils.showNotification('Links updated successfully');
                                location.reload();
                            } else {
                                throw new Error(data.error || 'Failed to update links');
                            }
                        } catch (error) {
                            utils.showNotification('Failed to update links', 'error');
                            console.error('Error:', error);
                        }
                    });
                }
            }
        };

        // Profile Update Handler
        const profileUpdateHandler = {
            init: function () {
                const profileForm = document.getElementById('profileForm');
                if (profileForm) {
                    profileForm.addEventListener('submit', this.handleSubmit.bind(this));
                }
            },
            handleSubmit: async function (e) {
                e.preventDefault();
                const formData = new FormData(e.target);

                try {
                    const response = await fetch('{{ url_for("profile") }}', {
                        method: 'POST',
                        body: formData,
                        headers: { 'X-Requested-With': 'XMLHttpRequest' }
                    });

                    const data = await response.json();
                    if (data.success) {
                        utils.showNotification('Profile updated successfully');
                        location.reload();
                    } else {
                        utils.showNotification('Update failed', 'error');
                    }
                } catch (error) {
                    utils.showNotification('Failed to update profile', 'error');
                }
            }
        };

        // Certificate Management
        const certificateHandler = {
            init: function () {
                this.setupCertificateUpload();
                this.setupCertificateDeletion();
            },
            setupCertificateUpload: function () {
                const certificateForm = document.getElementById('certificateForm');
                if (certificateForm) {
                    certificateForm.addEventListener('submit', async function (e) {
                        e.preventDefault();
                        const formData = new FormData();
                        const title = document.getElementById('certTitle').value;
                        const file = this.querySelector('input[type="file"]').files[0];

                        if (!file) {
                            utils.showNotification('Please select a file', 'error');
                            return;
                        }

                        formData.append('title', title);
                        formData.append('certificate', file);

                        try {
                            const response = await fetch(window.location.href, {
                                method: 'POST',
                                body: formData,
                                headers: { 'X-Requested-With': 'XMLHttpRequest' }
                            });

                            const data = await response.json();
                            if (data.success) {
                                utils.showNotification('Certificate uploaded successfully');
                                closeUploadModal();
                                location.reload();
                            } else {
                                throw new Error(data.error || 'Upload failed');
                            }
                        } catch (error) {
                            console.error('Upload error:', error);
                            utils.showNotification('Failed to upload certificate', 'error');
                        }
                    });
                }
            },
            setupCertificateDeletion: function () {
                window.deleteCertificate = async function (certId) {
                    if (confirm('Are you sure you want to delete this certificate?')) {
                        try {
                            const response = await fetch(`/delete-certificate/${certId}`, {
                                method: 'DELETE',
                            });
                            if (response.ok) {
                                utils.showNotification('Certificate deleted successfully');
                                window.location.reload();
                            } else {
                                throw new Error('Failed to delete certificate');
                            }
                        } catch (error) {
                            utils.showNotification('Error deleting certificate', 'error');
                            console.error('Error:', error);
                        }
                    }
                };
            }
        };

        // Utility Functions
        window.copyProfileLink = function () {
            const profileLink = `{{ request.host_url }}{{ user_data.username }}`;
            navigator.clipboard.writeText(profileLink).then(() => {
                utils.showNotification('Profile link copied to clipboard!');
            }).catch(err => {
                utils.showNotification('Failed to copy link', 'error');
            });
        };

        window.showUploadModal = function () {
            const modal = document.getElementById('uploadModal');
            modal.classList.add('modal-open');
        };

        window.closeUploadModal = function () {
            const modal = document.getElementById('uploadModal');
            modal.classList.remove('modal-open');
            document.getElementById('certificateForm').reset();
            document.getElementById('previewContainer').classList.add('hidden');
        };

        window.previewCertificate = function (input) {
            const previewContainer = document.getElementById('previewContainer');
            const imagePreview = document.getElementById('imagePreview');

            if (input.files && input.files[0]) {
                const file = input.files[0];
                if (file.type.startsWith('image/')) {
                    const reader = new FileReader();
                    reader.onload = function (e) {
                        imagePreview.src = e.target.result;
                        previewContainer.classList.remove('hidden');
                    }
                    reader.readAsDataURL(file);
                } else {
                    previewContainer.classList.add('hidden');
                }
            }
        };

        window.previewImage = function (input) {
            const preview = document.getElementById('avatarPreview');
            const file = input.files[0];
            const reader = new FileReader();

            reader.onloadend = function () {
                preview.src = reader.result;
            }

            if (file) {
                reader.readAsDataURL(file);
            } else {
                preview.src = "{{ avatar_url }}";
            }
        };

        // Initialize all handlers
        function init() {
            avatarHandler.init();
            academicPortfolioHandler.init();
            linksHandler.init();
            profileUpdateHandler.init();
            certificateHandler.init();
        }

        // Run initialization
        init();
    });
    document.addEventListener('DOMContentLoaded', function () {
        // Attach event listener to header input
        const headerInput = document.getElementById('headerInput');
        if (headerInput) {
            headerInput.addEventListener('change', function (e) {
                handleHeaderUpload(this);
            });
        } else {
            console.error('Header input element not found');
        }
    });
    let headerEditor = {
        verticalPos: 50,
        horizontalPos: 50
    };
    document.addEventListener('DOMContentLoaded', () => {
        const xSlider = document.getElementById('xPosition');
        const ySlider = document.getElementById('yPosition');

        if (xSlider && ySlider) {
            xSlider.addEventListener('input', updateHeaderPreviewPosition);
            ySlider.addEventListener('input', updateHeaderPreviewPosition);
        }
    });

    function updateHeaderPreviewPosition() {
        const xSlider = document.getElementById('xPosition');
        const ySlider = document.getElementById('yPosition');

        if (!xSlider || !ySlider) return;

        const x = xSlider.value;
        const y = ySlider.value;

        const desktopPreview = document.getElementById('desktopHeaderPreview');
        const mobilePreview = document.getElementById('mobileHeaderPreview');

        if (desktopPreview) desktopPreview.style.objectPosition = `${x}% ${y}%`;
        if (mobilePreview) mobilePreview.style.objectPosition = `${x}% ${y}%`;

        // Update stored values
        headerEditor.horizontalPos = x;
        headerEditor.verticalPos = y;
    }

    function updatePosition(x, y) {
        const preview = document.getElementById('headerPreview');
        if (preview) {
            preview.style.objectPosition = `${x}% ${y}%`;
        }
    }

    function handleHeaderUpload(input) {
        if (!input.files || !input.files[0]) return;

        const file = input.files[0];

        // Проверка размера и типа файла
        if (file.size > 5 * 1024 * 1024) {
            alert('Размер файла должен быть меньше 5 МБ');
            return;
        }

        if (!file.type.startsWith('image/')) {
            alert('Можно загружать только изображения');
            return;
        }

        // Принудительное создание модального окна, если оно отсутствует
        let headerEditorModal = document.getElementById('headerEditorModal');
        if (!headerEditorModal) {
            headerEditorModal = document.createElement('div');
            headerEditorModal.id = 'headerEditorModal';
            headerEditorModal.className = 'modal';
            headerEditorModal.innerHTML = `
            <div class="modal-box max-w-4xl p-8">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                    <div>
                        <h4 class="text-sm font-medium text-gray-700 mb-2">Desktop Preview</h4>
                        <div class="relative w-full h-[300px] bg-gray-100 rounded-xl overflow-hidden">
                            <img id="desktopHeaderPreview" src="" alt="Desktop header preview" 
                                 class="w-full h-full object-cover">
                        </div>
                    </div>
                    <div>
                        <h4 class="text-sm font-medium text-gray-700 mb-2">Mobile Preview</h4>
                        <div class="relative w-full h-[200px] bg-gray-100 rounded-xl overflow-hidden">
                            <img id="mobileHeaderPreview" src="" alt="Mobile header preview" 
                                 class="w-full h-full object-cover">
                        </div>
                    </div>
                </div>
            </div>
        `;
            document.body.appendChild(headerEditorModal);
        }

        const reader = new FileReader();

        reader.onload = function (e) {
            // Форсированное получение элементов
            const desktopPreview = document.getElementById('desktopHeaderPreview') ||
                (() => {
                    const img = document.createElement('img');
                    img.id = 'desktopHeaderPreview';
                    img.className = 'w-full h-full object-cover';
                    document.querySelector('.modal-box').appendChild(img);
                    return img;
                })();

            const mobilePreview = document.getElementById('mobileHeaderPreview') ||
                (() => {
                    const img = document.createElement('img');
                    img.id = 'mobileHeaderPreview';
                    img.className = 'w-full h-full object-cover';
                    document.querySelector('.modal-box').appendChild(img);
                    return img;
                })();

            // Принудительная установка src
            desktopPreview.src = e.target.result;
            mobilePreview.src = e.target.result;

            // Открытие модального окна
            headerEditorModal.classList.add('modal-open');

            // Сброс позиции
            const xSlider = document.getElementById('xPosition') ||
                (() => {
                    const slider = document.createElement('input');
                    slider.id = 'xPosition';
                    slider.type = 'range';
                    slider.min = '0';
                    slider.max = '100';
                    slider.value = '50';
                    document.querySelector('.modal-box').appendChild(slider);
                    return slider;
                })();

            const ySlider = document.getElementById('yPosition') ||
                (() => {
                    const slider = document.createElement('input');
                    slider.id = 'yPosition';
                    slider.type = 'range';
                    slider.min = '0';
                    slider.max = '100';
                    slider.value = '50';
                    document.querySelector('.modal-box').appendChild(slider);
                    return slider;
                })();

            xSlider.value = '50';
            ySlider.value = '50';

            // Сохранение файла
            headerEditor.file = file;
        };

        reader.readAsDataURL(file);
    }



    function saveHeaderImage() {
        if (!headerEditor.file) {
            showNotification('Please select an image', 'error');
            return;
        }

        const formData = new FormData();
        formData.append('header_image', headerEditor.file);
        formData.append('position', `${headerEditor.horizontalPos}% ${headerEditor.verticalPos}%`);

        fetch('/update_header', {
            method: 'POST',
            body: formData
        })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Update main header image
                    const headerImage = document.getElementById('headerImage');
                    headerImage.src = data.header.url;
                    headerImage.style.objectPosition = data.header.position;

                    closeHeaderEditor();
                    showNotification('Header updated successfully');
                } else {
                    throw new Error(data.error || 'Failed to update header');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                showNotification('Failed to update header image', 'error');
            });
    }





    function closeHeaderEditor() {
        document.getElementById('headerEditorModal').classList.remove('modal-open');
        currentHeaderFile = null;
    }



    let currentSkills = {{ user_data.skills| tojson | safe if user_data.skills else '[]' }};
    // Добавим слушатели для слайдеров
    document.addEventListener('DOMContentLoaded', () => {
        const xSlider = document.getElementById('xPosition');
        const ySlider = document.getElementById('yPosition');

        xSlider.addEventListener('input', updateHeaderPreviewPosition);
        ySlider.addEventListener('input', updateHeaderPreviewPosition);
    });
    function showSkillsEditor() {
        const modal = document.getElementById('skillsModal');
        const skillsList = document.getElementById('skillsList');
        skillsList.innerHTML = '';

        currentSkills.forEach(skill => addSkillInput(skill));
        modal.classList.add('modal-open');
    }

    // Update the addSkillInput function
    function addSkillInput(value = '') {
        const skillsList = document.getElementById('skillsList');
        if (!skillsList) return;

        const skillDiv = document.createElement('div');
        skillDiv.className = 'flex items-center gap-2 mb-2';

        // Create input element separately so we can set its value properly
        const input = document.createElement('input');
        input.className = 'input input-bordered flex-1';
        input.type = 'text';
        input.placeholder = 'Enter skill (e.g., Python, C++)';
        input.maxLength = 20;
        if (value) {
            input.value = value; // Only set value if one is provided
        }

        const removeBtn = document.createElement('button');
        removeBtn.type = 'button';
        removeBtn.className = 'btn btn-ghost btn-sm text-red-500 hover:bg-red-50';
        removeBtn.textContent = 'Remove';
        removeBtn.addEventListener('click', (e) => {
            e.preventDefault();
            e.stopPropagation();
            skillDiv.remove();
        });

        // Add elements to the div
        skillDiv.appendChild(input);
        skillDiv.appendChild(removeBtn);
        skillsList.appendChild(skillDiv);

        // Focus the new input
        input.focus();
    }



    async function saveSkills() {
        const skills = Array.from(document.querySelectorAll('#skillsList input'))
            .map(input => input.value.trim())
            .filter(skill => skill !== '');

        try {
            const response = await fetch('/update-skills', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ skills })
            });

            const data = await response.json();
            if (data.success) {
                currentSkills = skills;
                updateSkillsDisplay();
                closeSkillsModal();
                showNotification('Skills updated successfully');
            } else {
                throw new Error(data.error);
            }
        } catch (error) {
            showNotification('Failed to update skills', 'error');
        }
    }

    function updateSkillsDisplay() {
        const container = document.getElementById('skillsContainer');
        container.innerHTML = currentSkills.map(skill => `
        <span class="px-3 py-1 text-sm font-medium bg-purple-50 text-purple-700 rounded-full">
            ${skill}
        </span>
    `).join('');
    }

    function closeSkillsModal() {
        document.getElementById('skillsModal').classList.remove('modal-open');
    }
    // Add this at the bottom of your existing script section, outside any existing event listeners
    document.addEventListener('DOMContentLoaded', function () {
        // Skills Management
        const skillsModal = document.getElementById('skillsModal');
        const showSkillsEditorBtn = document.querySelector('[onclick="showSkillsEditor"]');

        if (showSkillsEditorBtn) {
            showSkillsEditorBtn.addEventListener('click', function (e) {
                e.preventDefault(); // Prevent default form submission
                showSkillsEditor();
            });
        }

        // Location Management
        function initializeLocation() {
            if (!navigator.geolocation) {
                console.log('Geolocation is not supported by this browser.');
                return;
            }

            navigator.geolocation.getCurrentPosition(
                async position => {
                    try {
                        const response = await fetch('/update-location', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify({
                                coordinates: {
                                    lat: position.coords.latitude,
                                    lng: position.coords.longitude
                                }
                            })
                        });

                        const data = await response.json();
                        if (data.success) {
                            const locationEl = document.querySelector('[data-location]');
                            if (locationEl) {
                                locationEl.textContent = `${data.location.city}, ${data.location.country}`;
                            }
                        }
                    } catch (error) {
                        console.error('Error updating location:', error);
                    }
                },
                error => {
                    console.log('Error getting location:', error);
                    // Fallback to IP-based location
                    fetchIPBasedLocation();
                }
            );
        }

        async function fetchIPBasedLocation() {
            try {
                const response = await fetch('/get-ip-location');
                const data = await response.json();
                if (data.success) {
                    const locationEl = document.querySelector('[data-location]');
                    if (locationEl) {
                        locationEl.textContent = `${data.location.city}, ${data.location.country}`;
                    }
                }
            } catch (error) {
                console.error('Error fetching IP location:', error);
            }
        }

        // Initialize location on page load
        initializeLocation();
    });

    // Move the skills functions outside the DOMContentLoaded event
    function showSkillsEditor() {
        const modal = document.getElementById('skillsModal');
        const skillsList = document.getElementById('skillsList');
        if (!modal || !skillsList) return;

        skillsList.innerHTML = '';
        currentSkills.forEach(skill => addSkillInput(skill));
        modal.classList.add('modal-open');
    }

    function closeSkillsModal() {
        const modal = document.getElementById('skillsModal');
        if (modal) {
            modal.classList.remove('modal-open');
        }
    }

    function addSkillInput(value = '') {
        const skillsList = document.getElementById('skillsList');
        if (!skillsList) return;

        const skillDiv = document.createElement('div');
        skillDiv.className = 'flex items-center gap-2 mb-2';
        skillDiv.innerHTML = `
        <input type="text" class="input input-bordered flex-1" value="${value}" 
               placeholder="Enter skill (e.g., Python, C++)" maxlength="20">
        <button type="button" class="btn btn-ghost btn-sm text-red-500 hover:bg-red-50">
            Remove
        </button>
    `;

        skillDiv.querySelector('button').addEventListener('click', function () {
            skillDiv.remove();
        });

        skillsList.appendChild(skillDiv);
    }

    async function saveSkills() {
        const inputs = document.querySelectorAll('#skillsList input');
        const skills = Array.from(inputs)
            .map(input => input.value.trim())
            .filter(skill => skill !== '');

        try {
            const response = await fetch('/update-skills', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ skills })
            });

            const data = await response.json();
            if (data.success) {
                currentSkills = skills;
                updateSkillsDisplay();
                closeSkillsModal();
                showNotification('Skills updated successfully');
            } else {
                throw new Error(data.error);
            }
        } catch (error) {
            showNotification('Failed to update skills', 'error');
            console.error('Error:', error);
        }
    }

    function updateSkillsDisplay() {
        const container = document.getElementById('skillsContainer');
        if (!container) return;

        container.innerHTML = currentSkills.map(skill => `
        <span class="px-3 py-1 text-sm font-medium bg-purple-50 text-purple-700 rounded-full">
            ${skill}
        </span>
    `).join('');
    }
    // Modify the Skills Management Event Handlers
    document.addEventListener('DOMContentLoaded', function () {
        // Update the button click handler to properly prevent form submission
        const skillsEditorBtn = document.querySelector('button[onclick="showSkillsEditor()"]');
        if (skillsEditorBtn) {
            skillsEditorBtn.onclick = function (e) {
                e.preventDefault();
                e.stopPropagation();
                const modal = document.getElementById('skillsModal');
                const skillsList = document.getElementById('skillsList');
                if (!modal || !skillsList) return;

                skillsList.innerHTML = '';
                currentSkills.forEach(skill => addSkillInput(skill));
                modal.classList.add('modal-open');
            };
        }

        // Prevent form submission when clicking inside the modal
        const skillsModal = document.getElementById('skillsModal');
        if (skillsModal) {
            skillsModal.addEventListener('click', function (e) {
                e.stopPropagation();
            });

            // Prevent modal from closing when clicking inside
            skillsModal.querySelector('.modal-box').addEventListener('click', function (e) {
                e.stopPropagation();
            });
        }

        // Update modal close handler
        const closeModalBtn = document.querySelector('button[onclick="closeSkillsModal()"]');
        if (closeModalBtn) {
            closeModalBtn.onclick = function (e) {
                e.preventDefault();
                e.stopPropagation();
                const modal = document.getElementById('skillsModal');
                if (modal) {
                    modal.classList.remove('modal-open');
                }
            };
        }
    });

    // Update the save skills function to prevent form submission
    async function saveSkills(e) {
        if (e) {
            e.preventDefault();
            e.stopPropagation();
        }

        const inputs = document.querySelectorAll('#skillsList input');
        const skills = Array.from(inputs)
            .map(input => input.value.trim())
            .filter(skill => skill !== '');

        try {
            const response = await fetch('/update-skills', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ skills })
            });

            const data = await response.json();
            if (data.success) {
                currentSkills = skills;
                updateSkillsDisplay();
                document.getElementById('skillsModal').classList.remove('modal-open');
                showNotification('Skills updated successfully');
            } else {
                throw new Error(data.error);
            }
        } catch (error) {
            showNotification('Failed to update skills', 'error');
            console.error('Error:', error);
        }
    }
    // Replace the existing skills functions with these updated versions
    function showSkillsEditor(e) {
        if (e) {
            e.preventDefault();
            e.stopPropagation();
        }
        const modal = document.getElementById('skillsModal');
        const skillsList = document.getElementById('skillsList');
        if (!modal || !skillsList) return;

        // Clear existing skills
        skillsList.innerHTML = '';

        // Add current skills
        currentSkills.forEach(skill => addSkillInput(skill));

        // Show modal
        modal.classList.add('modal-open');
    }

    function addSkillInput(value = '') {
        const skillsList = document.getElementById('skillsList');
        if (!skillsList) return;

        const skillDiv = document.createElement('div');
        skillDiv.className = 'flex items-center gap-2 mb-2';
        skillDiv.innerHTML = `
        <input type="text" class="input input-bordered flex-1" value="${value}" 
               placeholder="Enter skill (e.g., Python, C++)" maxlength="20">
        <button type="button" class="btn btn-ghost btn-sm text-red-500 hover:bg-red-50">Remove</button>
    `;

        // Add click handler for remove button
        const removeBtn = skillDiv.querySelector('button');
        removeBtn.addEventListener('click', (e) => {
            e.preventDefault();
            e.stopPropagation();
            skillDiv.remove();
        });

        skillsList.appendChild(skillDiv);
    }

    async function saveSkills(e) {
        if (e) {
            e.preventDefault();
            e.stopPropagation();
        }

        const inputs = document.querySelectorAll('#skillsList input');
        const skills = Array.from(inputs)
            .map(input => input.value.trim())
            .filter(skill => skill !== '');

        try {
            const response = await fetch('/update-skills', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ skills })
            });

            const data = await response.json();
            if (data.success) {
                currentSkills = skills;
                updateSkillsDisplay();
                closeSkillsModal();
                showNotification('Skills updated successfully');
            } else {
                throw new Error(data.error);
            }
        } catch (error) {
            showNotification('Failed to update skills', 'error');
            console.error('Error:', error);
        }
    }

    function closeSkillsModal(e) {
        if (e) {
            e.preventDefault();
            e.stopPropagation();
        }
        const modal = document.getElementById('skillsModal');
        if (modal) {
            modal.classList.remove('modal-open');
        }
    }


    // Update the addNewSkill button handler
    function addNewSkill(e) {
        if (e) {
            e.preventDefault();
            e.stopPropagation();
        }

        const skillsList = document.getElementById('skillsList');
        if (!skillsList) return;

        const skillDiv = document.createElement('div');
        skillDiv.className = 'flex items-center gap-2 mb-2';

        // Create input element
        const input = document.createElement('input');
        input.className = 'input input-bordered flex-1';
        input.type = 'text';
        input.placeholder = 'Enter skill (e.g., Python, C++)';
        input.maxLength = 20;

        // Create remove button
        const removeBtn = document.createElement('button');
        removeBtn.type = 'button';
        removeBtn.className = 'btn btn-ghost btn-sm text-red-500 hover:bg-red-50';
        removeBtn.textContent = 'Remove';
        removeBtn.addEventListener('click', (e) => {
            e.preventDefault();
            e.stopPropagation();
            skillDiv.remove();
        });

        // Add elements to the div
        skillDiv.appendChild(input);
        skillDiv.appendChild(removeBtn);
        skillsList.appendChild(skillDiv);

        // Focus the new input
        input.focus();
    }
    // Update DOMContentLoaded event handler
    // Update the DOMContentLoaded event handler
    document.addEventListener('DOMContentLoaded', function () {
        // Prevent form submission/bubbling on modal clicks
        const skillsModal = document.getElementById('skillsModal');
        if (skillsModal) {
            skillsModal.addEventListener('click', (e) => e.stopPropagation());

            const modalBox = skillsModal.querySelector('.modal-box');
            if (modalBox) {
                modalBox.addEventListener('click', (e) => e.stopPropagation());
            }
        }

        // Clean up and set single event listener for Add Skill button
        const addSkillBtn = document.querySelector('button[onclick="addNewSkill(event)"]');
        if (addSkillBtn) {
            // Remove the inline onclick attribute
            addSkillBtn.removeAttribute('onclick');
            // Add single event listener
            addSkillBtn.addEventListener('click', addNewSkill);
        }
    });

    // Header Management
    let currentHeaderFile = null;


    function updatePosition(x, y) {
        const preview = document.getElementById('headerPreview');
        if (preview) {
            preview.style.objectPosition = `${x}% ${y}%`;
        }
    }


    function showNotification(message, type = 'success') {
        const toast = document.createElement('div');
        toast.className = `fixed bottom-4 right-4 px-6 py-3 rounded-lg shadow-lg z-50 
                      ${type === 'error' ? 'bg-red-500' : 'bg-black'} text-white`;
        toast.textContent = message;
        document.body.appendChild(toast);

        setTimeout(() => {
            toast.remove();
        }, 3000);
    }

    function closeHeaderEditor() {
        const modal = document.getElementById('headerEditorModal');
        if (modal) {
            modal.classList.remove('modal-open');
        }
        currentHeaderFile = null;
    }

    // Position slider handlers
    document.addEventListener('DOMContentLoaded', function () {
        const xSlider = document.getElementById('xPosition');
        const ySlider = document.getElementById('yPosition');

        if (xSlider && ySlider) {
            xSlider.addEventListener('input', function () {
                updatePosition(this.value, ySlider.value);
            });

            ySlider.addEventListener('input', function () {
                updatePosition(xSlider.value, this.value);
            });
        }
    });
</script>
{% endblock %}