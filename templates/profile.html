{% extends "base.html" %}
{% block content %}
<div class="container mx-auto px-4 py-12">
    <div class="max-w-5xl mx-auto">
        <div class="grid grid-cols-1 md:grid-cols-3 gap-8">
            <div class="md:col-span-1">
                <div class="bg-white rounded-2xl shadow-sm p-6 mb-6">
                    <div class="relative group w-32 h-32 mx-auto mb-4">
                        <img id="avatarPreview" src="{{ avatar_url }}" class="w-full h-full object-cover rounded-2xl"
                            alt="Profile picture">
                        <label
                            class="absolute inset-0 rounded-2xl bg-black bg-opacity-50 opacity-0 group-hover:opacity-100 flex items-center justify-center cursor-pointer transition-opacity">
                            <span class="text-white text-sm">Change Photo</span>
                            <input type="file" name="avatar" accept="image/*" class="hidden"
                                onchange="previewImage(this)">
                        </label>
                    </div>

                    <div class="flex items-center justify-center md:justify-start gap-4">
                        <h1 class="text-3xl font-bold gradient-text">
                            {{ user_data.full_name if user_data and user_data.full_name else 'Your Name' }}
                        </h1>

                        {% if user_data.verified %}
                        <div class="tooltip"
                            data-tip="{{ 'Officially verified account' if user_data.verification_type == 'official' else 'Verified account' }}">
                            <svg xmlns="http://www.w3.org/2000/svg"
                                class="h-6 w-6 text-blue-500 transition-all duration-300 transform hover:scale-110 hover:rotate-6"
                                viewBox="0 0 20 20" fill="currentColor">
                                <path fill-rule="evenodd"
                                    d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z"
                                    clip-rule="evenodd" />
                            </svg>
                        </div>
                        {% endif %}

                        <button onclick="copyProfileLink()" class="btn btn-ghost btn-sm" title="Copy Profile Link">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-gray-500 hover:text-black"
                                fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z" />
                            </svg>
                        </button>
                    </div>

                    <p class="text-gray-600 mt-2 flex items-center justify-center md:justify-start gap-2">
                        @{{ user_data.username if user_data else '' }}

                    </p>

                    <div class="flex justify-center gap-2 mt-4">
                        <span class="px-3 py-1 bg-gray-100 rounded-full text-sm">
                            {{ certificates|length }} Certificates
                        </span>
                        <span class="px-3 py-1 bg-gray-100 rounded-full text-sm">
                            Member since {{ user_data.created_at.strftime('%B %Y') if user_data and user_data.created_at
                            else 'Recently' }}
                        </span>
                    </div>
                </div>

                <div class="bg-white rounded-2xl shadow-sm p-6 mb-6">
                    <h2 class="text-xl font-semibold mb-4">Profile Information</h2>
                    <form method="POST" enctype="multipart/form-data" id="profileForm">
                        <div class="space-y-4">
                            <div class="form-control">
                                <label class="label">Full Name</label>
                                <input type="text" name="full_name" class="input input-bordered bg-gray-50"
                                    value="{{ user_data.full_name if user_data else '' }}">
                            </div>

                            <div class="form-control">
                                <label class="label">Bio</label>
                                <textarea name="bio"
                                    class="textarea textarea-bordered bg-gray-50 min-h-[100px]">{{ user_data.bio if user_data else '' }}</textarea>
                            </div>

                            <div class="form-control">
                                <label class="label">Education</label>
                                <textarea name="education"
                                    class="textarea textarea-bordered bg-gray-50">{{ user_data.education if user_data else '' }}</textarea>
                            </div>

                            <button type="submit" class="btn bg-black hover:bg-gray-800 text-white w-full">
                                Save Changes
                            </button>
                        </div>
                    </form>
                </div>


                <div class="bg-white rounded-2xl shadow-sm p-6">

                    <h2 class="text-xl font-semibold">Your Links</h2>

                </div>
                <form id="linksForm" class="space-y-4">
                    <div id="linksContainer" class="space-y-4">
                        {% if user_data.links %}
                        {% for link in user_data.links %}
                        <div
                            class="link-entry group flex items-center gap-4 p-3 bg-gray-50 rounded-xl hover:bg-gray-100 transition-colors">
                            <div class="link-icon flex-shrink-0">
                                {% if 'linkedin.com' in link.url %}
                                <svg class="h-8 w-8 text-blue-600" fill="currentColor" viewBox="0 0 24 24">
                                    <path
                                        d="M19 0h-14c-2.761 0-5 2.239-5 5v14c0 2.761 2.239 5 5 5h14c2.762 0 5-2.239 5-5v-14c0-2.761-2.238-5-5-5zm-11 19h-3v-11h3v11zm-1.5-12.268c-.966 0-1.75-.79-1.75-1.764s.784-1.764 1.75-1.764 1.75.79 1.75 1.764-.783 1.764-1.75 1.764zm13.5 12.268h-3v-5.604c0-3.368-4-3.113-4 0v5.604h-3v-11h3v1.765c1.396-2.586 7-2.777 7 2.476v6.759z" />
                                </svg>
                                {% elif 'github.com' in link.url %}
                                <svg class="h-8 w-8 text-gray-900" fill="currentColor" viewBox="0 0 24 24">
                                    <path
                                        d="M12 0c-6.626 0-12 5.373-12 12 0 5.302 3.438 9.8 8.207 11.387.599.111.793-.261.793-.577v-2.234c-3.338.726-4.033-1.416-4.033-1.416-.546-1.387-1.333-1.756-1.333-1.756-1.089-.745.083-.729.083-.729 1.205.084 1.839 1.237 1.839 1.237 1.07 1.834 2.807 1.304 3.492.997.107-.775.418-1.305.762-1.604-2.665-.305-5.467-1.334-5.467-5.931 0-1.311.469-2.381 1.236-3.221-.124-.303-.535-1.524.117-3.176 0 0 1.008-.322 3.301 1.23.957-.266 1.983-.399 3.003-.404 1.02.005 2.047.138 3.006.404 2.291-1.552 3.297-1.23 3.297-1.23.653 1.653.242 2.874.118 3.176.77.84 1.235 1.911 1.235 3.221 0 4.609-2.807 5.624-5.479 5.921.43.372.823 1.102.823 2.222v3.293c0 .319.192.694.801.576 4.765-1.589 8.199-6.086 8.199-11.386 0-6.627-5.373-12-12-12z" />
                                </svg>
                                {% elif 'youtube.com' in link.url or 'youtu.be' in link.url %}
                                <svg class="h-8 w-8 text-red-600" fill="currentColor" viewBox="0 0 24 24">
                                    <path
                                        d="M19.615 3.184c-3.604-.246-11.631-.245-15.23 0-3.897.266-4.356 2.62-4.385 8.816.029 6.185.484 8.549 4.385 8.816 3.6.245 11.626.246 15.23 0 3.897-.266 4.356-2.62 4.385-8.816-.029-6.185-.484-8.549-4.385-8.816zm-10.615 12.816v-8l8 3.993-8 4.007z" />
                                </svg>
                                {% elif 'instagram.com' in link.url %}
                                <svg class="h-8 w-8 text-pink-600" fill="currentColor" viewBox="0 0 24 24">
                                    <path
                                        d="M12 2.163c3.204 0 3.584.012 4.85.07 3.252.148 4.771 1.691 4.919 4.919.058 1.265.069 1.645.069 4.849 0 3.205-.012 3.584-.069 4.849-.148 3.225-1.664 4.771-4.919 4.919-1.266.058-1.644.07-4.85.07-3.204 0-3.584-.012-4.849-.07-3.26-.148-4.771-1.699-4.919-4.92-.058-1.265-.07-1.644-.07-4.849 0-3.204.013-3.583.07-4.849.149-3.227 1.664-4.771 4.919-4.919 1.266-.057 1.645-.069 4.849-.069zm0-2.163c-3.259 0-3.667.014-4.947.072-4.358.2-6.78 2.618-6.98 6.98-.059 1.281-.073 1.689-.073 4.948 0 3.259.014 3.668.072 4.948.2 4.358 2.618 6.78 6.98 6.98 1.281.058 1.689.072 4.948.072 3.259 0 3.668-.014 4.948-.072 4.354-.2 6.782-2.618 6.979-6.98.059-1.28.073-1.689.073-4.948 0-3.259-.014-3.667-.072-4.947-.196-4.354-2.617-6.78-6.979-6.98-1.281-.059-1.69-.073-4.948-.073zm0 5.838c-3.403 0-6.162 2.759-6.162 6.162s2.759 6.163 6.162 6.163 6.162-2.759 6.162-6.163c0-3.403-2.759-6.162-6.162-6.162zm0 10.162c-2.209 0-4-1.79-4-4 0-2.209 1.791-4 4-4s4 1.791 4 4c0 2.21-1.791 4-4 4zm6.406-11.845c-.796 0-1.441.645-1.441 1.44s.645 1.44 1.441 1.44c.795 0 1.439-.645 1.439-1.44s-.644-1.44-1.439-1.44z" />
                                </svg>
                                {% elif 'twitter.com' in link.url or 'x.com' in link.url %}
                                <svg class="h-8 w-8 text-blue-400" fill="currentColor" viewBox="0 0 24 24">
                                    <path
                                        d="M24 4.557c-.883.392-1.832.656-2.828.775 1.017-.609 1.798-1.574 2.165-2.724-.951.564-2.005.974-3.127 1.195-.897-.957-2.178-1.555-3.594-1.555-3.179 0-5.515 2.966-4.797 6.045-4.091-.205-7.719-2.165-10.148-5.144-1.29 2.213-.669 5.108 1.523 6.574-.806-.026-1.566-.247-2.229-.616-.054 2.281 1.581 4.415 3.949 4.89-.693.188-1.452.232-2.224.084.626 1.956 2.444 3.379 4.6 3.419-2.07 1.623-4.678 2.348-7.29 2.04 2.179 1.397 4.768 2.212 7.548 2.212 9.142 0 14.307-7.721 13.995-14.646.962-.695 1.797-1.562 2.457-2.549z" />
                                </svg>
                                {% elif 'behance.net' in link.url %}
                                <svg class="h-8 w-8 text-blue-700" fill="currentColor" viewBox="0 0 24 24">
                                    <path
                                        d="M22 7h-7v-2h7v2zm1.726 10c-.442 1.297-2.029 3-5.101 3-3.074 0-5.564-1.729-5.564-5.675 0-3.91 2.325-5.727 5.466-5.727 3.082 0 4.964 1.718 5.176 4.587.014.256.105.744-.034 1.02h-7.418c.115 1.688 1.119 2.342 2.647 2.342 1.675 0 2.228-.56 2.428-1.247h1.998zm-7.64-2.598h4.362c-.042-1.297-1.023-1.948-2.089-1.948-1.209 0-2.144.68-2.273 1.948zm-9.886-8.402v14h-2.285v-14h2.285zm-2-2h-2v18h2v-18zm12.402 2h-3.953v1.137h3.953v-1.137zm3.398 0h-2v9h2v-9z" />
                                </svg>
                                {% elif 'dribbble.com' in link.url %}
                                <svg class="h-8 w-8 text-pink-500" fill="currentColor" viewBox="0 0 24 24">
                                    <path
                                        d="M12 0c-6.628 0-12 5.373-12 12s5.372 12 12 12 12-5.373 12-12-5.372-12-12-12zm9.885 11.441c-2.575-.422-4.943-.397-7.237.167-.244-.563-.497-1.125-.767-1.68 2.31-1 4.623-2.437 6.358-4.639-1.398 1.168-2.948 2.381-4.353 3.074-1.231-1.48-2.624-2.88-4.132-3.897 1.261 2.803 1.695 5.02 1.441 7.207-2.525.469-5.614-1.787-7.336-4.51.534 2.876 3.137 6.221 6.221 7.836-1.02.301-2.088.435-3.197.398-1.631-.045-3.939-1.127-5.031-2.74 1.034 2.962 3.952 5.408 6.931 5.657-1.15.935-3.983 1.409-5.406 1.345 4.141 2.654 9.426 2.105 12.566-.981 2.289-2.334 2.978-5.762 2.737-8.786z" />
                                </svg>
                                {% elif 'medium.com' in link.url %}
                                <svg class="h-8 w-8 text-black" fill="currentColor" viewBox="0 0 24 24">
                                    <path
                                        d="M2.846 6.887c.03-.295-.083-.586-.303-.784l-2.24-2.7v-.403h6.958l5.378 11.795 4.728-11.795h6.633v.403l-1.916 1.837c-.165.126-.247.333-.213.538v13.498c-.034.204.048.411.213.537l1.871 1.837v.403h-9.412v-.403l1.939-1.882c.19-.19.19-.246.19-.537v-10.91l-5.389 13.688h-.728l-6.275-13.688v9.174c-.052.385.076.774.323 1.054l2.523 3.06v.403h-7.148v-.403l2.524-3.06c.24-.28.345-.67.288-1.054v-10.6z" />
                                </svg>
                                {% elif 'portfolio' in link.url or 'personal' in link.url %}
                                <svg class="h-8 w-8 text-emerald-600" fill="none" viewBox="0 0 24 24"
                                    stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M21 13.255A23.931 23.931 0 0112 15c-3.183 0-6.22-.62-9-1.745M16 6V4a2 2 0 00-2-2h-4a2 2 0 00-2 2v2m4 6h.01M5 20h14a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z" />
                                </svg>
                                {% else %}
                                <svg class="h-8 w-8 text-gray-500" fill="none" viewBox="0 0 24 24"
                                    stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M13.828 10.172a4 4 0 00-5.656 0l-4 4a4 4 0 105.656 5.656l1.102-1.101m-.758-4.899a4 4 0 005.656 0l4-4a4 4 0 00-5.656-5.656l-1.1 1.1" />
                                </svg>
                                {% endif %}
                            </div>
                            <div class="flex-grow">
                                <input type="text" name="link_titles[]" placeholder="Link Title"
                                    class="input input-bordered w-full bg-white focus:border-primary transition-colors"
                                    value="{{ link.title }}">
                                <input type="text" name="link_urls[]" placeholder="URL"
                                    class="input input-bordered w-full bg-white mt-2 focus:border-primary transition-colors"
                                    value="{{ link.url }}">
                            </div>
                            <div class="flex-shrink-0 flex items-center space-x-2">
                                <a href="{{ link.url }}" target="_blank"
                                    class="btn btn-ghost btn-sm text-primary hover:bg-primary/10">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none"
                                        viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                            d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14" />
                                    </svg>
                                </a>
                                <button type="button" onclick="removeLink(this)"
                                    class="btn btn-ghost btn-sm text-red-500 hover:bg-red-50">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none"
                                        viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                            d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                                    </svg>
                                </button>
                            </div>
                        </div>
                        {% endfor %}
                        {% endif %}
                    </div>
                    <div class="flex justify-end space-x-4 mt-4">
                        <button type="button" onclick="addLink()"
                            class="btn btn-ghost text-primary hover:bg-primary/10 transition-colors">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24"
                                stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M12 4v16m8-8H4" />
                            </svg>
                            Add Link
                        </button>
                        <button type="submit" class="btn bg-primary text-white hover:bg-primary-dark transition-colors">
                            Save Changes
                        </button>
                    </div>
                </form>
            </div>

            <div class="md:col-span-2 space-y-6">
                <div class="bg-white rounded-2xl shadow-sm p-6">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-xl font-semibold">Certificates</h2>
                        <button onclick="showUploadModal()" class="btn bg-black hover:bg-gray-800 text-white">
                            Add Certificate
                        </button>
                    </div>
                    {% if certificates %}
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                        {% for cert_doc in certificates %}
                        {% set cert = cert_doc.to_dict() %}
                        <div class="card bg-gray-50 hover:bg-gray-100 transition-colors">
                            {% if cert.file_url and (cert.file_url.endswith('.jpg') or
                            cert.file_url.endswith('.jpeg')
                            or cert.file_url.endswith('.png')) %}
                            <figure class="relative h-48">
                                <img src="{{ cert.file_url }}" alt="{{ cert.title }}"
                                    class="w-full h-full object-cover">
                            </figure>
                            {% else %}
                            <div class="h-48 flex items-center justify-center bg-gray-100">
                                <svg class="h-16 w-16 text-gray-400" fill="none" viewBox="0 0 24 24"
                                    stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                                </svg>
                            </div>
                            {% endif %}
                            <div class="card-body">
                                <h3 class="card-title">{{ cert.title }}</h3>
                                {% if cert.uploaded_at %}
                                <p class="text-sm text-gray-500">
                                    {{ cert.uploaded_at.strftime('%B %d, %Y') }}
                                </p>
                                {% endif %}
                                <div class="card-actions justify-between mt-4">
                                    <a href="{{ cert.file_url }}" target="_blank"
                                        class="btn btn-sm bg-black hover:bg-gray-800 text-white">
                                        View
                                    </a>
                                    <button onclick="deleteCertificate('{{ cert_doc.id }}')"
                                        class="btn btn-sm btn-ghost text-red-500">
                                        Delete
                                    </button>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                    {% else %}
                    <div class="text-center py-12 bg-gray-50 rounded-xl">
                        <svg class="mx-auto h-12 w-12 text-gray-400" fill="none" viewBox="0 0 24 24"
                            stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M9 13h6m-3-3v6m5 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                        </svg>
                        <h3 class="mt-2 text-sm font-medium text-gray-900">No certificates</h3>
                        <p class="mt-1 text-sm text-gray-500">Get started by adding your first certificate</p>
                        <div class="mt-6">
                            <button onclick="showUploadModal()" class="btn bg-black hover:bg-gray-800 text-white">
                                Add Certificate
                            </button>
                        </div>
                    </div>
                    {% endif %}
                </div>
                <div class="bg-white rounded-2xl shadow-sm p-6">
                    <h2 class="text-2xl font-bold mb-4">Academic Portfolio</h2>
                    <form id="academicPortfolioForm">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div class="form-control">
                                <label class="label">GPA</label>
                                <input type="text" name="gpa" placeholder="Enter your GPA" class="input input-bordered"
                                    value="{{ user_data.academic_info.gpa }}">
                            </div>

                            <div class="form-control">
                                <label class="label">SAT Score</label>
                                <input type="text" name="sat_score" placeholder="Enter SAT Score"
                                    class="input input-bordered" value="{{ user_data.academic_info.sat_score }}">
                            </div>

                            <div class="form-control">
                                <label class="label">TOEFL Score</label>
                                <input type="text" name="toefl_score" placeholder="TOEFL Score"
                                    class="input input-bordered" value="{{ user_data.academic_info.toefl_score }}">
                            </div>

                            <div class="form-control">
                                <label class="label">IELTS Score</label>
                                <input type="text" name="ielts_score" placeholder="IELTS Score"
                                    class="input input-bordered" value="{{ user_data.academic_info.ielts_score }}">
                            </div>
                        </div>

                        <div class="mt-6">
                            <h3 class="text-xl font-semibold mb-4">Languages</h3>
                            <div id="languagesContainer">
                                {% for language in user_data.academic_info.languages %}
                                <div class="flex gap-4 mb-2">
                                    <input type="text" name="language_name" placeholder="Language"
                                        class="input input-bordered flex-1" value="{{ language.name }}">
                                    <select name="language_level" class="select select-bordered">
                                        <option value="A1" {% if language.level=='A1' %}selected{% endif %}>A1
                                        </option>
                                        <option value="A2" {% if language.level=='A2' %}selected{% endif %}>A2
                                        </option>
                                        <option value="B1" {% if language.level=='B1' %}selected{% endif %}>B1
                                        </option>
                                        <option value="B2" {% if language.level=='B2' %}selected{% endif %}>B2
                                        </option>
                                        <option value="C1" {% if language.level=='C1' %}selected{% endif %}>C1
                                        </option>
                                        <option value="C2" {% if language.level=='C2' %}selected{% endif %}>C2
                                        </option>
                                    </select>
                                    <button type="button" class="btn btn-ghost text-red-500">Remove</button>
                                </div>
                                {% endfor %}
                            </div>
                            <button type="button" id="addLanguageBtn" class="btn bg-black hover:bg-gray-800 text-white">
                                Add Language
                            </button>
                        </div>

                        <div class="mt-6">
                            <h3 class="text-xl font-semibold mb-4">Achievements</h3>
                            <div id="achievementsContainer">
                                {% for achievement in user_data.academic_info.achievements %}
                                <div class="mb-4 p-4 bg-gray-50 rounded-lg">
                                    <input type="text" name="achievement_title" placeholder="Achievement Title"
                                        class="input input-bordered w-full mb-2" value="{{ achievement.title }}">
                                    <textarea name="achievement_description" placeholder="Description"
                                        class="textarea textarea-bordered w-full mb-2">{{ achievement.description }}</textarea>
                                    <input type="date" name="achievement_date" class="input input-bordered"
                                        value="{{ achievement.date }}">
                                    <button type="button" class="btn btn-ghost text-red-500 mt-2">Remove</button>
                                </div>
                                {% endfor %}
                            </div>
                            <button type="button" id="addAchievementBtn"
                                class="btn bg-black hover:bg-gray-800 text-white">
                                Add Achievement
                            </button>
                        </div>
                        <!-- Модальное окно для загрузки -->

                        <div class="form-control mt-6">
                            <button type="submit" class="btn bg-black hover:bg-gray-800 text-white w-full">
                                Save Academic Portfolio
                            </button>
                        </div>
                    </form>
                </div>


            </div>
        </div>
    </div>
    <div id="uploadModal" class="modal">
        <div class="modal-box">
            <h3 class="font-bold text-lg mb-4">Upload Certificate</h3>
            <form id="certificateForm" class="space-y-4">
                <div class="form-control">
                    <label class="label">
                        <span class="label-text">Certificate Title</span>
                    </label>
                    <input type="text" id="certTitle" name="title" class="input input-bordered" required>
                </div>

                <div class="form-control">
                    <label class="label">
                        <span class="label-text">Certificate File</span>
                    </label>
                    <input type="file" name="certificate" accept=".pdf,.jpg,.jpeg,.png"
                        class="file-input file-input-bordered w-full" onchange="previewCertificate(this)" required>
                </div>

                <div id="previewContainer" class="hidden mt-4">
                    <img id="imagePreview" class="max-h-48 mx-auto" alt="Preview">
                </div>

                <div class="modal-action">
                    <button type="submit" class="btn btn-primary">Upload</button>
                    <button type="button" onclick="closeUploadModal()" class="btn">Cancel</button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        // Utility Functions
        const utils = {
            debounce: function (func, delay) {
                let timeoutId;
                return (...args) => {
                    clearTimeout(timeoutId);
                    timeoutId = setTimeout(() => func.apply(null, args), delay);
                };
            },
            showNotification: function (message, type = 'success') {
                const notification = document.createElement('div');
                notification.className = `fixed top-4 right-4 z-50 px-4 py-2 rounded-lg ${type === 'success' ? 'bg-black text-white' : 'bg-red-500 text-white'} transition-opacity duration-300`;
                notification.textContent = message;
                document.body.appendChild(notification);

                setTimeout(() => {
                    notification.style.opacity = '0';
                    setTimeout(() => notification.remove(), 300);
                }, 3000);
            }
        };

        // Avatar Upload Handler
        const avatarHandler = {
            init: function () {
                const avatarInput = document.querySelector('input[name="avatar"]');
                if (avatarInput) {
                    avatarInput.addEventListener('change', this.handleUpload.bind(this));
                }
            },
            handleUpload: async function (event) {
                const file = event.target.files[0];
                if (!file) return;

                const formData = new FormData();
                formData.append('avatar', file);

                try {
                    const response = await fetch('{{ url_for("profile") }}', {
                        method: 'POST',
                        body: formData,
                        headers: { 'X-Requested-With': 'XMLHttpRequest' }
                    });

                    const data = await response.json();
                    if (data.success) {
                        document.getElementById('avatarPreview').src = data.avatar_url;
                        const navAvatars = document.querySelectorAll('.avatar img');
                        navAvatars.forEach(avatar => {
                            avatar.src = data.avatar_url;
                        });
                        utils.showNotification('Avatar updated successfully');
                    } else {
                        utils.showNotification('Failed to update avatar', 'error');
                    }
                } catch (error) {
                    console.error('Error:', error);
                    utils.showNotification('Error updating avatar', 'error');
                }
            }
        };

        // Academic Portfolio Handler
        const academicPortfolioHandler = {
            init: function () {
                this.setupFormListeners();
                this.setupLanguageManagement();
                this.setupAchievementManagement();
            },
            setupFormListeners: function () {
                const academicForm = document.getElementById('academicPortfolioForm');
                if (academicForm) {
                    const scoreFields = ['gpa', 'sat_score', 'toefl_score', 'ielts_score'];
                    scoreFields.forEach(field => {
                        const input = academicForm.querySelector(`[name="${field}"]`);
                        if (input) {
                            input.addEventListener('input', utils.debounce(this.savePortfolio.bind(this), 1000));
                        }
                    });

                    academicForm.addEventListener('submit', async function (e) {
                        e.preventDefault();
                        await academicPortfolioHandler.savePortfolio();
                    });
                }
            },
            setupLanguageManagement: function () {
                const addLanguageBtn = document.getElementById('addLanguageBtn');
                const languagesContainer = document.getElementById('languagesContainer');

                if (addLanguageBtn && languagesContainer) {
                    addLanguageBtn.addEventListener('click', () => {
                        const newLanguageRow = this.createLanguageRow();
                        languagesContainer.appendChild(newLanguageRow);
                    });

                    languagesContainer.addEventListener('input', utils.debounce(this.savePortfolio.bind(this), 1000));
                }
            },
            setupAchievementManagement: function () {
                const addAchievementBtn = document.getElementById('addAchievementBtn');
                const achievementsContainer = document.getElementById('achievementsContainer');

                if (addAchievementBtn && achievementsContainer) {
                    addAchievementBtn.addEventListener('click', () => {
                        const newAchievementRow = this.createAchievementRow();
                        achievementsContainer.appendChild(newAchievementRow);
                    });

                    achievementsContainer.addEventListener('input', utils.debounce(this.savePortfolio.bind(this), 1000));
                }
            },
            createLanguageRow: function () {
                const row = document.createElement('div');
                row.className = 'flex gap-4 mb-2';
                row.innerHTML = `
                <input type="text" name="language_name" placeholder="Language" 
                    class="input input-bordered flex-1">
                <select name="language_level" class="select select-bordered">
                    <option value="A1">A1</option>
                    <option value="A2">A2</option>
                    <option value="B1">B1</option>
                    <option value="B2">B2</option>
                    <option value="C1">C1</option>
                    <option value="C2">C2</option>
                </select>
                <button type="button" class="btn btn-ghost text-red-500">Remove</button>
            `;
                row.querySelector('button').addEventListener('click', () => row.remove());
                return row;
            },
            createAchievementRow: function () {
                const row = document.createElement('div');
                row.className = 'mb-4 p-4 bg-gray-50 rounded-lg';
                row.innerHTML = `
                <input type="text" name="achievement_title" placeholder="Achievement Title" 
                    class="input input-bordered w-full mb-2">
                <textarea name="achievement_description" placeholder="Description" 
                    class="textarea textarea-bordered w-full mb-2"></textarea>
                <input type="date" name="achievement_date" 
                    class="input input-bordered">
                <button type="button" class="btn btn-ghost text-red-500 mt-2">Remove</button>
            `;
                row.querySelector('button').addEventListener('click', () => row.remove());
                return row;
            },
            collectFormData: function () {
                const academicForm = document.getElementById('academicPortfolioForm');
                const formData = {
                    gpa: academicForm.querySelector('input[name="gpa"]').value,
                    sat_score: academicForm.querySelector('input[name="sat_score"]').value,
                    toefl_score: academicForm.querySelector('input[name="toefl_score"]').value,
                    ielts_score: academicForm.querySelector('input[name="ielts_score"]').value,
                    languages: [],
                    achievements: []
                };

                document.querySelectorAll('#languagesContainer > div').forEach(row => {
                    const name = row.querySelector('input[name="language_name"]').value;
                    const level = row.querySelector('select[name="language_level"]').value;
                    if (name) formData.languages.push({ name, level });
                });

                document.querySelectorAll('#achievementsContainer > div').forEach(row => {
                    const title = row.querySelector('input[name="achievement_title"]').value;
                    const description = row.querySelector('textarea[name="achievement_description"]').value;
                    const date = row.querySelector('input[name="achievement_date"]').value;
                    if (title) formData.achievements.push({ title, description, date });
                });

                return formData;
            },
            savePortfolio: async function () {
                const formData = this.collectFormData();

                try {
                    const response = await fetch('/update_academic_portfolio', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Accept': 'application/json'
                        },
                        body: JSON.stringify(formData)
                    });

                    const result = await response.json();
                    if (result.success) {
                        utils.showNotification('Academic portfolio updated successfully');
                    } else {
                        utils.showNotification(result.error || 'Error updating portfolio', 'error');
                    }
                } catch (error) {
                    console.error('Error:', error);
                    utils.showNotification('Something went wrong', 'error');
                }
            }
        };

        // Links Management
        const linksHandler = {
            init: function () {
                this.setupLinkManagement();
                this.setupLinksSubmission();
            },
            setupLinkManagement: function () {
                const addLinkBtn = document.querySelector('[onclick="addLink()"]');
                const linksContainer = document.getElementById('linksContainer');

                if (addLinkBtn && linksContainer) {
                    addLinkBtn.addEventListener('click', () => {
                        const linkEntry = this.createLinkEntry();
                        linksContainer.appendChild(linkEntry);
                    });
                }
            },
            createLinkEntry: function () {
                const linkEntry = document.createElement('div');
                linkEntry.className = 'link-entry group flex items-center gap-2';
                linkEntry.innerHTML = `
                <input type="text" name="link_titles[]" placeholder="Link Title" 
                    class="input input-bordered flex-1">
                <input type="text" name="link_urls[]" placeholder="URL" 
                    class="input input-bordered flex-1">
                <button type="button" class="btn btn-ghost text-red-500">Remove</button>
            `;
                linkEntry.querySelector('button').addEventListener('click', () => linkEntry.remove());
                return linkEntry;
            },
            setupLinksSubmission: function () {
                const linksForm = document.getElementById('linksForm');
                if (linksForm) {
                    linksForm.addEventListener('submit', async function (e) {
                        e.preventDefault();
                        const titles = Array.from(this.querySelectorAll('input[name="link_titles[]"]')).map(input => input.value.trim());
                        const urls = Array.from(this.querySelectorAll('input[name="link_urls[]"]')).map(input => input.value.trim());

                        const links = titles.map((title, index) => ({
                            title: title,
                            url: urls[index]
                        })).filter(link => link.title && link.url);

                        try {
                            const response = await fetch('{{ url_for("profile") }}', {
                                method: 'POST',
                                headers: {
                                    'Content-Type': 'application/json',
                                    'X-Requested-With': 'XMLHttpRequest'
                                },
                                body: JSON.stringify({
                                    action: 'update_links',
                                    links: links
                                })
                            });

                            const data = await response.json();
                            if (data.success) {
                                utils.showNotification('Links updated successfully');
                                location.reload();
                            } else {
                                throw new Error(data.error || 'Failed to update links');
                            }
                        } catch (error) {
                            utils.showNotification('Failed to update links', 'error');
                            console.error('Error:', error);
                        }
                    });
                }
            }
        };

        // Profile Update Handler
        const profileUpdateHandler = {
            init: function () {
                const profileForm = document.getElementById('profileForm');
                if (profileForm) {
                    profileForm.addEventListener('submit', this.handleSubmit.bind(this));
                }
            },
            handleSubmit: async function (e) {
                e.preventDefault();
                const formData = new FormData(e.target);

                try {
                    const response = await fetch('{{ url_for("profile") }}', {
                        method: 'POST',
                        body: formData,
                        headers: { 'X-Requested-With': 'XMLHttpRequest' }
                    });

                    const data = await response.json();
                    if (data.success) {
                        utils.showNotification('Profile updated successfully');
                        location.reload();
                    } else {
                        utils.showNotification('Update failed', 'error');
                    }
                } catch (error) {
                    utils.showNotification('Failed to update profile', 'error');
                }
            }
        };

        // Certificate Management
        const certificateHandler = {
            init: function () {
                this.setupCertificateUpload();
                this.setupCertificateDeletion();
            },
            setupCertificateUpload: function () {
                const certificateForm = document.getElementById('certificateForm');
                if (certificateForm) {
                    certificateForm.addEventListener('submit', async function (e) {
                        e.preventDefault();
                        const formData = new FormData();
                        const title = document.getElementById('certTitle').value;
                        const file = this.querySelector('input[type="file"]').files[0];

                        if (!file) {
                            utils.showNotification('Please select a file', 'error');
                            return;
                        }

                        formData.append('title', title);
                        formData.append('certificate', file);

                        try {
                            const response = await fetch(window.location.href, {
                                method: 'POST',
                                body: formData,
                                headers: { 'X-Requested-With': 'XMLHttpRequest' }
                            });

                            const data = await response.json();
                            if (data.success) {
                                utils.showNotification('Certificate uploaded successfully');
                                closeUploadModal();
                                location.reload();
                            } else {
                                throw new Error(data.error || 'Upload failed');
                            }
                        } catch (error) {
                            console.error('Upload error:', error);
                            utils.showNotification('Failed to upload certificate', 'error');
                        }
                    });
                }
            },
            setupCertificateDeletion: function () {
                window.deleteCertificate = async function (certId) {
                    if (confirm('Are you sure you want to delete this certificate?')) {
                        try {
                            const response = await fetch(`/delete-certificate/${certId}`, {
                                method: 'DELETE',
                            });
                            if (response.ok) {
                                utils.showNotification('Certificate deleted successfully');
                                window.location.reload();
                            } else {
                                throw new Error('Failed to delete certificate');
                            }
                        } catch (error) {
                            utils.showNotification('Error deleting certificate', 'error');
                            console.error('Error:', error);
                        }
                    }
                };
            }
        };

        // Utility Functions
        window.copyProfileLink = function () {
            const profileLink = `{{ request.host_url }}{{ user_data.username }}`;
            navigator.clipboard.writeText(profileLink).then(() => {
                utils.showNotification('Profile link copied to clipboard!');
            }).catch(err => {
                utils.showNotification('Failed to copy link', 'error');
            });
        };

        window.showUploadModal = function () {
            const modal = document.getElementById('uploadModal');
            modal.classList.add('modal-open');
        };

        window.closeUploadModal = function () {
            const modal = document.getElementById('uploadModal');
            modal.classList.remove('modal-open');
            document.getElementById('certificateForm').reset();
            document.getElementById('previewContainer').classList.add('hidden');
        };

        window.previewCertificate = function (input) {
            const previewContainer = document.getElementById('previewContainer');
            const imagePreview = document.getElementById('imagePreview');

            if (input.files && input.files[0]) {
                const file = input.files[0];
                if (file.type.startsWith('image/')) {
                    const reader = new FileReader();
                    reader.onload = function (e) {
                        imagePreview.src = e.target.result;
                        previewContainer.classList.remove('hidden');
                    }
                    reader.readAsDataURL(file);
                } else {
                    previewContainer.classList.add('hidden');
                }
            }
        };

        window.previewImage = function (input) {
            const preview = document.getElementById('avatarPreview');
            const file = input.files[0];
            const reader = new FileReader();

            reader.onloadend = function () {
                preview.src = reader.result;
            }

            if (file) {
                reader.readAsDataURL(file);
            } else {
                preview.src = "{{ avatar_url }}";
            }
        };

        // Initialize all handlers
        function init() {
            avatarHandler.init();
            academicPortfolioHandler.init();
            linksHandler.init();
            profileUpdateHandler.init();
            certificateHandler.init();
        }

        // Run initialization
        init();
    });

</script>
{% endblock %}