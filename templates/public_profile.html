{% extends "base.html" %}
{% block content %}
<div class="min-h-screen gradient-bg py-12">
    <div class="container mx-auto px-4">
        <div class="max-w-5xl mx-auto">
            <div class="grid grid-cols-1 md:grid-cols-3 gap-8">
                <div class="md:col-span-1">
                    <div class="bg-white rounded-2xl shadow-sm p-6 mb-6">
                        <div class="relative w-32 h-32 mx-auto mb-4">
                            <img src="{{ avatar_url }}" class="w-full h-full object-cover rounded-2xl"
                                alt="{{ user_data.full_name if user_data else 'Profile' }}">
                        </div>

                        <div class="text-center md:text-left">
                            <div class="flex items-center justify-center md:justify-start gap-4">
                                {% if user_data.verified %}
                                <div class="tooltip"
                                    data-tip="{{ 'Officially verified account' if user_data.verification_type == 'official' else 'Verified account' }}">
                                    <svg xmlns="http://www.w3.org/2000/svg"
                                        class="h-6 w-6 text-blue-500 transition-all duration-300 transform hover:scale-110 hover:rotate-6"
                                        viewBox="0 0 20 20" fill="currentColor">
                                        <path fill-rule="evenodd"
                                            d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z"
                                            clip-rule="evenodd" />
                                    </svg>
                                </div>
                                {% endif %}
                                <h1 class="text-2xl font-bold">
                                    {{ user_data.full_name if user_data else 'User' }}
                                </h1>
                                <button onclick="copyProfileLink()" class="btn btn-ghost btn-sm"
                                    title="Copy Profile Link">
                                    <svg xmlns="http://www.w3.org/2000/svg"
                                        class="h-5 w-5 text-gray-500 hover:text-black" fill="none" viewBox="0 0 24 24"
                                        stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                            d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z" />
                                    </svg>
                                </button>
                            </div>
                            <p class="text-gray-600 mt-1">@{{ user_data.username if user_data else '' }}</p>
                        </div>

                        <div class="flex justify-center gap-2 mt-4">
                            {% if certificates_count > 0 %}
                            <div class="px-3 py-1 bg-gray-100 rounded-full text-sm">
                                <span class="font-semibold">{{ certificates_count }}</span>
                                <span class="text-gray-600 ml-1">Certificates</span>
                            </div>
                            {% endif %}

                            {% if user_data.created_at %}
                            <div class="px-3 py-1 bg-gray-100 rounded-full text-sm">
                                <span class="text-gray-600">Member since </span>
                                <span class="font-semibold">
                                    {{ user_data.created_at.strftime('%B %Y') }}
                                </span>
                            </div>
                            {% endif %}
                        </div>
                        <!-- Links Section -->
                        {% if user_data.links %}
                        <div class="bg-white rounded-2xl  p-6 mb-6">
                            <h3 class="text-xl font-semibold mb-4">Links</h3>
                            <div class="space-y-3">
                                {% for link in user_data.links %}
                                <a href="{{ link.url }}" target="_blank"
                                    class="flex items-center p-3 bg-gray-50 rounded-xl hover:bg-gray-100 transition-colors">
                                    {% if 'youtube.com' in link.url or 'youtu.be' in link.url %}
                                    <svg class="h-5 w-5 text-red-600 mr-3" fill="currentColor" viewBox="0 0 24 24">
                                        <path
                                            d="M19.615 3.184c-3.604-.246-11.631-.245-15.23 0-3.897.266-4.356 2.62-4.385 8.816.029 6.185.484 8.549 4.385 8.816 3.6.245 11.626.246 15.23 0 3.897-.266 4.356-2.62 4.385-8.816-.029-6.185-.484-8.549-4.385-8.816zm-10.615 12.816v-8l8 3.993-8 4.007z" />
                                    </svg>
                                    {% elif 'github.com' in link.url %}
                                    <svg class="h-5 w-5 text-gray-900 mr-3" fill="currentColor" viewBox="0 0 24 24">
                                        <path
                                            d="M12 0c-6.626 0-12 5.373-12 12 0 5.302 3.438 9.8 8.207 11.387.599.111.793-.261.793-.577v-2.234c-3.338.726-4.033-1.416-4.033-1.416-.546-1.387-1.333-1.756-1.333-1.756-1.089-.745.083-.729.083-.729 1.205.084 1.839 1.237 1.839 1.237 1.07 1.834 2.807 1.304 3.492.997.107-.775.418-1.305.762-1.604-2.665-.305-5.467-1.334-5.467-5.931 0-1.311.469-2.381 1.236-3.221-.124-.303-.535-1.524.117-3.176 0 0 1.008-.322 3.301 1.23.957-.266 1.983-.399 3.003-.404 1.02.005 2.047.138 3.006.404 2.291-1.552 3.297-1.23 3.297-1.23.653 1.653.242 2.874.118 3.176.77.84 1.235 1.911 1.235 3.221 0 4.609-2.807 5.624-5.479 5.921.43.372.823 1.102.823 2.222v3.293c0 .319.192.694.801.576 4.765-1.589 8.199-6.086 8.199-11.386 0-6.627-5.373-12-12-12z" />
                                    </svg>
                                    {% elif 'linkedin.com' in link.url %}
                                    <svg class="h-5 w-5 text-blue-600 mr-3" fill="currentColor" viewBox="0 0 24 24">
                                        <path
                                            d="M19 0h-14c-2.761 0-5 2.239-5 5v14c0 2.761 2.239 5 5 5h14c2.762 0 5-2.239 5-5v-14c0-2.761-2.238-5-5-5zm-11 19h-3v-11h3v11zm-1.5-12.268c-.966 0-1.75-.79-1.75-1.764s.784-1.764 1.75-1.764 1.75.79 1.75 1.764-.783 1.764-1.75 1.764zm13.5 12.268h-3v-5.604c0-3.368-4-3.113-4 0v5.604h-3v-11h3v1.765c1.396-2.586 7-2.777 7 2.476v6.759z" />
                                    </svg>
                                    {% else %}
                                    <svg class="h-5 w-5 text-gray-400 mr-3" fill="none" viewBox="0 0 24 24"
                                        stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                            d="M13.828 10.172a4 4 0 00-5.656 0l-4 4a4 4 0 105.656 5.656l1.102-1.101m-.758-4.899a4 4 0 005.656 0l4-4a4 4 0 00-5.656-5.656l-1.1 1.1" />
                                    </svg>
                                    {% endif %}
                                    <span class="text-gray-900 font-medium">{{ link.title }}</span>
                                </a>
                                {% endfor %}
                            </div>
                        </div>
                        {% endif %}
                    </div>


                    <!-- Bio Section -->
                    {% if user_data.bio %}
                    <div class="bg-white rounded-2xl shadow-sm p-6 mb-6">
                        <h3 class="text-xl font-semibold mb-4">About Me</h3>
                        <p class="text-gray-700 leading-relaxed">{{ user_data.bio }}</p>
                    </div>
                    {% endif %}
                </div>

                <div class="md:col-span-2 space-y-6">
                    <!-- Academic Profile -->
                    {% if user_data.academic_info %}
                    <div class="bg-white rounded-2xl shadow-sm p-6">
                        <h2 class="text-2xl font-bold mb-6">Academic Profile</h2>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div>
                                <h3 class="text-lg font-semibold mb-4">Academic Metrics</h3>
                                <div class="space-y-2">
                                    <div>GPA: {{ user_data.academic_info.gpa or 'Not provided' }}</div>
                                    <div>SAT Score: {{ user_data.academic_info.sat_score or 'Not provided' }}</div>
                                    <div>TOEFL: {{ user_data.academic_info.toefl_score or 'Not provided' }}</div>
                                    <div>IELTS: {{ user_data.academic_info.ielts_score or 'Not provided' }}</div>
                                </div>
                            </div>

                            <div>
                                <h3 class="text-lg font-semibold mb-4">Languages</h3>
                                <div class="space-y-2">
                                    {% for lang in user_data.academic_info.languages %}
                                    <div>
                                        {{ lang.name }} - {{ lang.level }}
                                    </div>
                                    {% endfor %}
                                </div>
                            </div>
                        </div>

                        {% if user_data.academic_info.achievements %}
                        <div class="mt-6">
                            <h3 class="text-lg font-semibold mb-4">Achievements</h3>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                {% for achievement in user_data.academic_info.achievements %}
                                <div class="bg-gray-50 p-4 rounded-lg">
                                    <h4 class="font-semibold">{{ achievement.title }}</h4>
                                    <p>{{ achievement.description }}</p>
                                    <small class="text-gray-500">{{ achievement.date }}</small>
                                </div>
                                {% endfor %}
                            </div>
                        </div>
                        {% endif %}
                    </div>
                    {% endif %}

                    <!-- Certificates -->
                    {% if certificates %}
                    <div class="bg-white rounded-2xl shadow-sm p-6">
                        <h2 class="text-2xl font-bold mb-6">Certificates & Achievements</h2>
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                            {% for cert_doc in certificates %}
                            {% set cert = cert_doc.to_dict() %}
                            <div class="card bg-gray-50 hover:bg-gray-100 transition-colors">
                                {% if cert.file_url and (cert.file_url.endswith('.jpg') or
                                cert.file_url.endswith('.jpeg') or cert.file_url.endswith('.png')) %}
                                <figure class="relative h-48">
                                    <img src="{{ cert.file_url }}" alt="{{ cert.title }}"
                                        class="w-full h-full object-cover">
                                </figure>
                                {% else %}
                                <div class="h-48 flex items-center justify-center bg-gray-100">
                                    <svg class="h-16 w-16 text-gray-400" fill="none" viewBox="0 0 24 24"
                                        stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                            d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                                    </svg>
                                </div>
                                {% endif %}
                                <div class="card-body">
                                    <h3 class="card-title">{{ cert.title }}</h3>
                                    {% if cert.uploaded_at %}
                                    <p class="text-sm text-gray-500">
                                        {{ cert.uploaded_at.strftime('%B %d, %Y') }}
                                    </p>
                                    {% endif %}
                                    <div class="card-actions justify-between mt-4">
                                        <a href="{{ cert.file_url }}" target="_blank"
                                            class="btn btn-sm bg-black hover:bg-gray-800 text-white">
                                            View
                                        </a>
                                    </div>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                    {% endif %}

                </div>
            </div>

            <!-- Comments Section -->
            <div class="max-w-5xl mx-auto mt-8">
                <div class="bg-white rounded-2xl shadow-sm p-6">
                    <h2 class="text-2xl font-bold mb-6 flex items-center">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 mr-3 text-gray-600" fill="none"
                            viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z" />
                        </svg>
                        Comments
                        <span id="commentCount" class="ml-2 text-sm text-gray-500">(0)</span>
                    </h2>

                    {% if session.get('user_id') and session['user_id'] != user_data.uid %}
                    <div class="mb-6 bg-gray-50 rounded-xl p-4">
                        <form id="commentForm" class="space-y-4">
                            <textarea id="commentText"
                                class="textarea textarea-bordered w-full min-h-[100px] resize-y bg-white"
                                placeholder="Share your thoughts about this profile..." maxlength="500"
                                required></textarea>
                            <div class="flex justify-between items-center">
                                <span id="charCount" class="text-sm text-gray-500">0 / 500</span>
                                <button type="submit"
                                    class="btn bg-black hover:bg-gray-800 text-white flex items-center">
                                    Send Comment
                                </button>
                            </div>
                        </form>
                    </div>
                    {% endif %}
                    <div id="commentsList" class="space-y-4">
                        <!-- Comments will be dynamically loaded here -->
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>


<script>
    document.addEventListener('DOMContentLoaded', function () {

        const defaultAvatar = '{{ avatar_url }}';
        const username = '{{ user_data.username }}';
        const commentsList = document.getElementById('commentsList');
        const commentForm = document.getElementById('commentForm');
        const commentText = document.getElementById('commentText');
        const charCount = document.getElementById('charCount');
        const commentCount = document.getElementById('commentCount');

        // Character count
        commentText?.addEventListener('input', function () {
            const currentLength = this.value.length;
            charCount.textContent = `${currentLength} / 500`;
            charCount.classList.toggle('text-red-500', currentLength > 450);
        });

        function formatDate(dateString) {
            // Проверяем, является ли dateString объектом с _seconds
            if (dateString && dateString._seconds) {
                const date = new Date(dateString._seconds * 1000);
                const now = new Date();
                const diffMinutes = Math.floor((now - date) / (1000 * 60));

                if (diffMinutes < 1) return 'Just now';
                if (diffMinutes < 60) return `${diffMinutes} min ago`;
                if (diffMinutes < 1440) return `${Math.floor(diffMinutes / 60)} hours ago`;

                // Форматируем дату
                return date.toLocaleDateString('en-US', {
                    year: 'numeric',
                    month: 'short',
                    day: 'numeric'
                });
            }

            // Если dateString это timestamp в секундах
            if (typeof dateString === 'number') {
                const date = new Date(dateString * 1000);
                return date.toLocaleDateString('en-US', {
                    year: 'numeric',
                    month: 'short',
                    day: 'numeric'
                });
            }

            // Если dateString это объект Date или строка с датой
            if (dateString) {
                const date = new Date(dateString);
                if (!isNaN(date.getTime())) {
                    return date.toLocaleDateString('en-US', {
                        year: 'numeric',
                        month: 'short',
                        day: 'numeric'
                    });
                }
            }

            // Если ничего не подошло, возвращаем дефолтное значение
            return 'Date not available';
        }

        function formatComment(comment, isReply = false, nestingLevel = 0) {
            const currentUserId = '{{ session.get("user_id", "") }}';
            const profileUserId = '{{ user_data.uid }}';
            const authorUsername = comment.author_username;
            const replyToText = comment.reply_to_username ? `Replying to @${comment.reply_to_username}` : '';

            const marginLeft = Math.min(nestingLevel * 2, 8);

            const commentHTML = `
    <div class="comment flex bg-gray-50 p-4 rounded-xl space-x-4 group mb-4 ${isReply ? `ml-${marginLeft}` : ''}" 
         data-comment-id="${comment.id}" 
         data-parent-id="${comment.parent_id || ''}"
         data-reply-to="${comment.reply_to || ''}">
        <div class="flex-shrink-0">
            <a href="/${authorUsername.toLowerCase()}" class="block w-8 h-8 rounded-full overflow-hidden hover:ring-2 hover:ring-black transition-all"> 
                <img src="${comment.author_avatar}" alt="${comment.author_username}" class="w-full h-full object-cover">
            </a>
        </div>
        <div class="flex-grow">
            <div class="flex items-center gap-2 mb-1">
                <a href="/${authorUsername}" class="font-semibold text-sm hover:underline">@${comment.author_username}</a>
                <span class="text-xs text-gray-500">${formatDate(comment.created_at)}</span>
            </div>
            ${replyToText ? `<div class="text-xs text-gray-500 mb-1">${replyToText}</div>` : ''}
            <p class="text-gray-700 text-sm mb-2">${comment.text}</p>
            
            <div class="flex items-center gap-4 text-xs text-gray-500">
                <button onclick="toggleLike('${comment.id}')" 
                        class="flex items-center gap-1 ${comment.is_liked ? 'text-red-500' : ''} hover:text-red-500 transition-colors">
                    <svg class="h-4 w-4" fill="${comment.is_liked ? 'currentColor' : 'none'}" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" 
                              d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z" />
                    </svg>
                    <span class="likes-count">${comment.likes_count || 0}</span>
                </button>
                
                <button onclick="toggleReply('${comment.id}')" class="hover:text-gray-700 transition-colors">
                    Reply
                </button>
                
                ${(comment.author_id === currentUserId || profileUserId === currentUserId) ? `
                    <button onclick="deleteComment('${comment.id}')" class="hover:text-red-500 opacity-0 group-hover:opacity-100 transition-all">
                        Delete
                    </button>
                ` : ''}
            </div>

            <div class="reply-form hidden mt-3" id="reply-form-${comment.id}">
                <textarea class="textarea textarea-bordered w-full text-sm min-h-[60px] resize-none bg-white"
                        placeholder="Write a reply..."></textarea>
                <div class="flex justify-end mt-2">
                    <button onclick="submitReply('${comment.id}', '${comment.id}')"
                            class="btn btn-xs bg-black hover:bg-gray-800 text-white">
                        Reply
                    </button>
                </div>
            </div>

            ${comment.replies && comment.replies.length > 0 ? `
            <div class="replies-container hidden mt-3" id="replies-${comment.id}">
                ${comment.replies.map(reply => formatComment(reply, true, nestingLevel + 1)).join('')}
            </div>
            <button onclick="toggleRepliesView('${comment.id}')" 
                    class="text-xs text-gray-500 hover:text-black mt-2 flex items-center gap-1 see-replies-btn">
                <span class="replies-count">${comment.replies.length}</span>
                ${comment.replies.length === 1 ? 'reply' : 'replies'}
            </button>
            ` : ''}
        </div>
    </div>`;

            return commentHTML;
        }

        window.submitReply = async function (commentId, originalCommentId) {
            const replyForm = document.querySelector(`#reply-form-${commentId}`);
            const replyText = replyForm.querySelector('textarea').value.trim();
            const replyButton = replyForm.querySelector('button');

            if (!replyText) return;

            try {
                replyButton.disabled = true;
                replyButton.textContent = 'Sending...';

                const formData = new FormData();
                formData.append('reply', replyText);
                formData.append('original_comment_id', originalCommentId);

                const response = await fetch(`/${username}/comments/${commentId}/reply`, {
                    method: 'POST',
                    body: formData
                });

                const data = await response.json();

                if (response.ok) {
                    replyForm.querySelector('textarea').value = '';
                    replyForm.classList.add('hidden');

                    const parentComment = document.querySelector(`[data-comment-id="${commentId}"]`);
                    let repliesContainer = parentComment.querySelector('.replies-container');
                    let repliesButton = parentComment.querySelector('.see-replies-btn');

                    if (!repliesContainer) {
                        repliesContainer = document.createElement('div');
                        repliesContainer.classList.add('replies-container', 'hidden', 'mt-3');
                        repliesContainer.id = `replies-${commentId}`;
                        parentComment.querySelector('.flex-grow').appendChild(repliesContainer);
                    }

                    if (!repliesButton) {
                        repliesButton = document.createElement('button');
                        repliesButton.classList.add('text-xs', 'text-gray-500', 'hover:text-black', 'mt-2', 'flex', 'items-center', 'gap-1', 'see-replies-btn');
                        repliesButton.setAttribute('onclick', `toggleRepliesView('${commentId}')`);
                        parentComment.querySelector('.flex-grow').appendChild(repliesButton);
                    }

                    const replyHTML = formatComment(data.reply, true, 1);
                    repliesContainer.insertAdjacentHTML('beforeend', replyHTML);

                    repliesButton.innerHTML = `
                <span class="replies-count">${repliesContainer.children.length}</span>
                ${repliesContainer.children.length === 1 ? 'reply' : 'replies'}
            `;

                    showNotification('Reply added successfully');
                } else {
                    throw new Error(data.error || 'Failed to add reply');
                }
            } catch (error) {
                showNotification(error.message, 'error');
            } finally {
                replyButton.disabled = false;
                replyButton.textContent = 'Reply';
            }
        };

        window.toggleRepliesView = function (commentId) {
            const repliesContainer = document.querySelector(`#replies-${commentId}`);
            const repliesButton = document.querySelector(`[data-comment-id="${commentId}"] .see-replies-btn`);

            repliesContainer.classList.toggle('hidden');

            if (repliesContainer.classList.contains('hidden')) {
                repliesButton.innerHTML = `
            <span class="replies-count">${repliesContainer.children.length}</span>
            ${repliesContainer.children.length === 1 ? 'reply' : 'replies'}
        `;
            } else {
                repliesButton.textContent = 'Hide replies';
            }
        };








        // Load comments
        function loadComments() {
            fetch(`/${username}/comments`)
                .then(response => response.json())
                .then(comments => {
                    commentCount.textContent = `(${comments.length})`;
                    commentsList.innerHTML = comments.map(comment => formatComment(comment)).join('') || `
                    <div class="text-center text-gray-500 py-8">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-12 w-12 mx-auto mb-4 text-gray-300" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z" />
                        </svg>
                        No comments yet. Be the first to comment!
                    </div>
                `;
                });
        }

        // Submit comment form
        if (commentForm) {
            commentForm.addEventListener('submit', async function (e) {
                e.preventDefault();
                const commentTextValue = commentText.value.trim();

                if (commentTextValue.length > 500) {
                    showNotification('Comment is too long', 'error');
                    return;
                }

                try {
                    const response = await fetch(`/${username}/comments`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/x-www-form-urlencoded'
                        },
                        body: new URLSearchParams({ 'comment': commentTextValue })
                    });

                    const data = await response.json();
                    if (data.status === 'success') {
                        commentText.value = '';
                        charCount.textContent = '0 / 500';
                        showNotification('Comment added successfully');
                        loadComments();
                    }
                } catch (error) {
                    showNotification('Failed to send comment', 'error');
                }
            });
        }

        // Global functions
        window.toggleReply = function (commentId) {
            const replyForm = document.querySelector(`#reply-form-${commentId}`);
            replyForm.classList.toggle('hidden');
        };


        window.toggleLike = async function (commentId) {
            try {
                const response = await fetch(`/${username}/comments/${commentId}/like`, {
                    method: 'POST'
                });

                const data = await response.json();
                if (data.status === 'success') {
                    const commentElement = document.querySelector(`[data-comment-id="${commentId}"]`);
                    const likesCount = commentElement.querySelector('.likes-count');
                    const likeIcon = likesCount.previousElementSibling;

                    likesCount.textContent = data.likes_count;

                    if (data.is_liked) {
                        likeIcon.classList.add('text-red-500');
                        likeIcon.setAttribute('fill', 'currentColor');
                    } else {
                        likeIcon.classList.remove('text-red-500');
                        likeIcon.setAttribute('fill', 'none');
                    }
                }
            } catch (error) {
                showNotification('Failed to update like', 'error');
            }
        };

        window.deleteComment = async function (commentId) {
            if (!confirm('Are you sure you want to delete this comment?')) return;

            try {
                const response = await fetch(`/${username}/comments/${commentId}`, {
                    method: 'DELETE'
                });

                const data = await response.json();
                if (data.status === 'success') {
                    showNotification('Comment deleted successfully');
                    loadComments();
                }
            } catch (error) {
                showNotification('Failed to delete comment', 'error');
            }
        };

        function showNotification(message, type = 'success') {
            const notification = document.createElement('div');
            notification.className = `fixed top-4 right-4 z-50 px-6 py-3 rounded-xl shadow-lg transform transition-all duration-300 
            ${type === 'success' ? 'bg-black text-white' : 'bg-red-500 text-white'}`;
            notification.textContent = message;
            document.body.appendChild(notification);

            setTimeout(() => {
                notification.style.opacity = '0';
                setTimeout(() => notification.remove(), 300);
            }, 3000);
        }

        // Initial load
        loadComments();
    });

    // Profile link copying function
    function copyProfileLink() {
        const url = window.location.href;
        navigator.clipboard.writeText(url).then(() => {
            const notification = document.createElement('div');
            notification.className = 'fixed bottom-4 right-4 bg-black text-white px-6 py-3 rounded-xl shadow-lg transform transition-all duration-300';
            notification.textContent = 'Profile link copied to clipboard!';
            document.body.appendChild(notification);

            setTimeout(() => {
                notification.style.opacity = '0';
                setTimeout(() => notification.remove(), 300);
            }, 3000);
        });
    }
    function generateDefaultAvatar(username) {
        const initials = username.split(' ')
            .map(word => word[0])
            .join('')
            .toUpperCase()
            .slice(0, 2);
        return `https://ui-avatars.com/api/?name=${initials}&background=random&color=fff&size=128`;
    }
</script>
{% endblock %}